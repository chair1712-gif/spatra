<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portal Siswa Modern</title>
<style>
  /* --- 1. CSS VARIABLES (THEMING) --- */
  :root {
    /* Light Mode Default */
    --bg-body: #f3f4f6;
    --bg-card: #ffffff;
    --bg-header: rgba(255, 255, 255, 0.9);
    --text-main: #1f2937;
    --text-muted: #6b7280;
    --border-color: #e5e7eb;
    
    /* Default Color (Blue) */
    --primary: #4f46e5; 
    --primary-hover: #4338ca;
    --primary-light: #e0e7ff;
    
    /* Functional Colors */
    --danger: #ef4444;
    --success: #10b981;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --radius: 12px;
    --transition: all 0.3s ease;
  }

  /* Dark Mode Override */
  [data-theme="dark"] {
    --bg-body: #0f172a;
    --bg-card: #1e293b;
    --bg-header: rgba(15, 23, 42, 0.9);
    --text-main: #f1f5f9;
    --text-muted: #94a3b8;
    --border-color: #334155;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
  }

  /* Color Themes */
  [data-color="purple"] { --primary: #7c3aed; --primary-hover: #6d28d9; --primary-light: #ede9fe; }
  [data-color="rose"] { --primary: #e11d48; --primary-hover: #be123c; --primary-light: #ffe4e6; }
  [data-color="teal"] { --primary: #0d9488; --primary-hover: #0f766e; --primary-light: #ccfbf1; }

  /* --- 2. RESET & BASE STYLES --- */
  * { box-sizing: border-box; outline: none; }
  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background-color: var(--bg-body);
    color: var(--text-main);
    margin: 0;
    padding: 0;
    transition: background-color 0.3s, color 0.3s;
    padding-bottom: 80px; /* Space for mobile nav if needed, or scroll */
  }

  /* --- 3. COMPONENTS --- */
  
  /* Header */
  header {
    position: sticky; top: 0; z-index: 100;
    background: var(--bg-header);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border-color);
    padding: 15px 20px;
    display: flex; justify-content: space-between; align-items: center;
  }

  h1 { margin: 0; font-size: 20px; font-weight: 700; color: var(--primary); }
  
  /* Navigation Pills (Home / Dashboard) */
  .nav-pills {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 30px;
    padding: 4px;
    display: flex;
    gap: 5px;
  }
  .nav-pill {
    border: none; background: transparent; color: var(--text-muted);
    padding: 8px 16px; border-radius: 25px; font-weight: 600;
    cursor: pointer; transition: var(--transition); font-size: 14px;
  }
  .nav-pill.active {
    background: var(--primary); color: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  /* User Profile & Controls */
  .controls { display: flex; align-items: center; gap: 15px; }
  
  .btn-icon {
    background: transparent; border: 1px solid var(--border-color);
    color: var(--text-main); width: 36px; height: 36px; border-radius: 50%;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: var(--transition);
  }
  .btn-icon:hover { background: var(--primary-light); color: var(--primary); border-color: var(--primary); }

  .user-profile { display: flex; align-items: center; gap: 10px; }
  .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
  .user-info { display: flex; flex-direction: column; line-height: 1.2; }
  .user-name { font-weight: 700; font-size: 14px; }
  .user-class { font-size: 11px; color: var(--text-muted); }

  /* Buttons */
  .btn {
    background: var(--primary); color: white; border: none; padding: 10px 20px;
    border-radius: 8px; font-weight: 600; cursor: pointer; transition: var(--transition);
    display: inline-flex; align-items: center; gap: 8px; font-size: 14px;
  }
  .btn:hover { background: var(--primary-hover); transform: translateY(-1px); }
  .btn-logout { background: transparent; color: var(--danger); border: 1px solid var(--danger); }
  .btn-logout:hover { background: var(--danger); color: white; }

  /* --- 4. LAYOUTS & SECTIONS --- */
  .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

  .section-title {
    margin: 25px 0 15px 0; font-size: 18px; font-weight: 700;
    color: var(--text-main); display: flex; align-items: center; gap: 10px;
  }
  .section-title::before {
    content: ''; width: 4px; height: 18px; background: var(--primary); border-radius: 2px;
  }

  /* Filter Tabs (Chips) */
  .chip-container {
    display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px;
    scrollbar-width: none; /* Firefox */
  }
  .chip-container::-webkit-scrollbar { display: none; }
  
  .chip {
    padding: 6px 16px; border-radius: 20px; background: var(--bg-card);
    border: 1px solid var(--border-color); color: var(--text-muted);
    font-size: 13px; font-weight: 600; white-space: nowrap; cursor: pointer;
    transition: var(--transition);
  }
  .chip.active { background: var(--primary); color: white; border-color: var(--primary); }
  .chip:hover:not(.active) { border-color: var(--primary); color: var(--primary); }

  /* --- 5. HORIZONTAL SCROLL (Gallery & Briev) --- */
  .scroll-wrapper {
    background: var(--bg-card); border-radius: var(--radius);
    padding: 15px; box-shadow: var(--shadow); border: 1px solid var(--border-color);
    position: relative;
    /* Gradient indicators for scroll */
    background-image: linear-gradient(to right, var(--bg-card), var(--bg-card) 95%, transparent 100%);
  }
  .scroll-row {
    display: flex; gap: 15px; overflow-x: auto;
    scroll-behavior: smooth; padding-bottom: 10px;
  }
  /* Custom Scrollbar */
  .scroll-row::-webkit-scrollbar { height: 4px; }
  .scroll-row::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }

  /* Card Design */
  .card {
    background: var(--bg-body); /* Slightly different than wrapper */
    border-radius: 10px; overflow: hidden;
    min-width: 220px; max-width: 240px;
    flex-shrink: 0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    transition: var(--transition); border: 1px solid transparent;
  }
  .card:hover {
    transform: translateY(-4px); box-shadow: var(--shadow);
    border-color: var(--primary-light);
  }
  .card img {
    width: 100%; height: 140px; object-fit: cover;
    background: #e5e7eb; transition: transform 0.5s;
  }
  .card:hover img { transform: scale(1.05); }
  
  .card-body { padding: 12px; }
  .card-tag {
    font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;
    color: var(--primary); font-weight: 700; margin-bottom: 5px;
  }
  .card-title {
    font-size: 15px; font-weight: 700; color: var(--text-main);
    margin: 0 0 8px 0; line-height: 1.3; display: -webkit-box;
    -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
  }
  .card-meta {
    font-size: 12px; color: var(--text-muted); margin-bottom: 10px;
    display: flex; align-items: center; gap: 5px;
  }
  .card-btn {
    width: 100%; padding: 8px; background: var(--bg-card);
    border: 1px solid var(--border-color); color: var(--primary);
    border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px;
  }
  .card-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }

  /* --- 6. BOOTCAMP (News Style) --- */
  .news-card {
    display: flex; background: var(--bg-card); border-radius: var(--radius);
    overflow: hidden; box-shadow: var(--shadow); margin-bottom: 15px;
    border: 1px solid var(--border-color); transition: var(--transition);
  }
  .news-card:hover { transform: scale(1.01); }
  .news-img {
    width: 130px; object-fit: cover; min-width: 130px; background: var(--bg-body);
  }
  .news-content { padding: 15px; flex: 1; display: flex; flex-direction: column; justify-content: center; }
  .news-date { font-size: 11px; color: var(--primary); font-weight: 600; margin-bottom: 5px; }
  .news-headline { font-size: 16px; font-weight: 700; margin: 0 0 5px 0; color: var(--text-main); }
  .news-excerpt { font-size: 13px; color: var(--text-muted); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

  @media (min-width: 768px) {
    .news-img { width: 250px; min-width: 250px; }
    .news-excerpt { -webkit-line-clamp: 3; }
  }

  /* --- 7. TUTORIAL (YouTube Style) --- */
  .yt-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(100%, 1fr)); gap: 20px;
  }
  @media (min-width: 600px) {
    .yt-grid { grid-template-columns: repeat(2, 1fr); }
  }
  @media (min-width: 900px) {
    .yt-grid { grid-template-columns: repeat(3, 1fr); }
  }

  .yt-card {
    background: transparent; cursor: pointer; transition: var(--transition);
  }
  .yt-thumb-box {
    width: 100%; aspect-ratio: 16/9; border-radius: 12px; overflow: hidden;
    background: var(--bg-body); position: relative;
    box-shadow: var(--shadow); margin-bottom: 10px;
  }
  .yt-thumb { width: 100%; height: 100%; object-fit: cover; transition: var(--transition); }
  .yt-card:hover .yt-thumb { transform: scale(1.05); }
  
  .yt-title { font-size: 14px; font-weight: 600; color: var(--text-main); margin-bottom: 5px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;}
  .yt-desc { font-size: 12px; color: var(--text-muted); }

  /* --- 8. MODAL & FORM --- */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px); z-index: 1000;
    display: none; align-items: center; justify-content: center; padding: 20px;
  }
  .modal-overlay.open { display: flex; animation: fadeIn 0.3s; }
  
  .modal {
    background: var(--bg-card); width: 100%; max-width: 450px;
    border-radius: 16px; padding: 25px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
    position: relative; border: 1px solid var(--border-color); animation: slideUp 0.3s;
  }
  
  .form-group { margin-bottom: 15px; }
  .form-label { display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--text-main); }
  .form-input {
    width: 100%; padding: 12px; border: 1px solid var(--border-color);
    border-radius: 8px; background: var(--bg-body); color: var(--text-main);
    transition: var(--transition);
  }
  .form-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
  
  /* Settings Panel (Theme Color) */
  .theme-options { display: flex; gap: 10px; margin-top: 10px; }
  .color-dot { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
  .color-dot.active { border-color: var(--text-main); transform: scale(1.1); }

  /* --- 9. TOAST & LOADER --- */
  .toast {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    background: var(--text-main); color: var(--bg-body);
    padding: 12px 24px; border-radius: 30px; font-size: 14px; font-weight: 600;
    box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); z-index: 2000; display: none;
  }
  
  .loader {
    border: 3px solid var(--bg-card); border-top: 3px solid var(--primary);
    border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 0 auto;
  }

  /* Animations */
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

  /* Visibility Helpers */
  .hidden { display: none !important; }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div style="display: flex; align-items: center; gap: 10px;">
    <!-- App Icon/Logo -->
    <div style="width:32px; height:32px; background:var(--primary); border-radius:8px; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold;">P</div>
    <h1>PortalSiswa</h1>
  </div>

  <!-- Navigation Tabs -->
  <nav class="nav-pills">
    <button class="nav-pill active" onclick="switchView('home')" id="pill-home">Beranda</button>
    <button class="nav-pill" onclick="switchView('dashboard')" id="pill-dashboard">Dashboard</button>
  </nav>

  <!-- Right Controls -->
  <div class="controls">
    <!-- Settings Icon (Theme/Color) -->
    <button class="btn-icon" onclick="openModal('settingsModal')">
      ‚öôÔ∏è
    </button>

    <!-- User Section -->
    <div id="auth-section">
      <button class="btn" id="btnLogin" onclick="openModal('loginModal')">Login</button>
      
      <div id="userProfile" class="user-profile hidden">
        <div class="user-info">
          <span class="user-name" id="dispName">Nama</span>
          <span class="user-class" id="dispClass">Kelas</span>
        </div>
        <img id="dispAvatar" class="user-avatar" src="">
        <button class="btn btn-logout" style="padding: 6px 12px; font-size: 12px; margin-left:5px;" onclick="logout()">Out</button>
        <button class="btn" id="btnUpload" style="background: var(--success); padding: 6px 12px;" onclick="openModal('uploadModal')">+ Upload</button>
      </div>
    </div>
  </div>
</header>

<!-- MAIN CONTAINER -->
<div class="container">
  
  <!-- === VIEW: BERANDA === -->
  <div id="view-home" class="view-section">
    
    <!-- Gallery -->
    <div class="section-title">Galeri Karya Siswa</div>
    <div class="chip-container" id="tabs-gallery">
      <button class="chip active" onclick="filterData('gallery', 'all')">Semua</button>
    </div>
    <div class="scroll-wrapper">
      <div id="loading-gallery" style="padding:20px;"><div class="loader"></div></div>
      <div class="scroll-row" id="row-gallery"></div>
    </div>

    <!-- Briev -->
    <div class="section-title">Info & Briefing</div>
    <div class="chip-container" id="tabs-briev">
      <button class="chip active" onclick="filterData('briev', 'all')">Semua</button>
    </div>
    <div class="scroll-wrapper">
      <div id="loading-briev" style="padding:20px;"><div class="loader"></div></div>
      <div class="scroll-row" id="row-briev"></div>
    </div>
  </div>

  <!-- === VIEW: DASHBOARD === -->
  <div id="view-dashboard" class="view-section hidden">
    
    <!-- Bootcamp -->
    <div class="section-title">Kegiatan Bootcamp</div>
    <div id="loading-bootcamp" style="padding:20px;"><div class="loader"></div></div>
    <div id="container-bootcamp"></div>

    <!-- Tutorial -->
    <div class="section-title">Tutorial Video</div>
    <div id="loading-tutorial" style="padding:20px;"><div class="loader"></div></div>
    <div id="container-tutorial" class="yt-grid"></div>
  </div>

</div>

<!-- === MODALS === -->

<!-- Login Modal -->
<div id="loginModal" class="modal-overlay">
  <div class="modal">
    <h2 style="margin-top:0; color:var(--primary);">Masuk Siswa</h2>
    <form onsubmit="handleLogin(event)">
      <div class="form-group">
        <label class="form-label">Username</label>
        <input type="text" id="username" class="form-input" required placeholder="Contoh: siswa01">
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" id="password" class="form-input" required>
      </div>
      <button type="submit" class="btn" style="width:100%; justify-content:center; margin-top:10px;">Login</button>
    </form>
    <button class="btn-icon" style="position:absolute; top:15px; right:15px;" onclick="closeModal('loginModal')">‚úï</button>
  </div>
</div>

<!-- Settings Modal (Theme/Color) -->
<div id="settingsModal" class="modal-overlay">
  <div class="modal">
    <h2 style="margin-top:0;">Pengaturan Tampilan</h2>
    <div class="form-group">
      <label class="form-label">Mode</label>
      <button class="btn" style="width:100%; justify-content:space-between;" onclick="toggleTheme()">
        <span id="theme-label">Mode Terang</span>
        <span id="theme-icon">‚òÄÔ∏è</span>
      </button>
    </div>
    <div class="form-group">
      <label class="form-label">Warna Tema</label>
      <div class="theme-options">
        <div class="color-dot active" style="background:#4f46e5;" onclick="setColor('blue', this)"></div>
        <div class="color-dot" style="background:#7c3aed;" onclick="setColor('purple', this)"></div>
        <div class="color-dot" style="background:#e11d48;" onclick="setColor('rose', this)"></div>
        <div class="color-dot" style="background:#0d9488;" onclick="setColor('teal', this)"></div>
      </div>
    </div>
    <button class="btn-icon" style="position:absolute; top:15px; right:15px;" onclick="closeModal('settingsModal')">‚úï</button>
  </div>
</div>

<!-- Upload Modal -->
<div id="uploadModal" class="modal-overlay">
  <div class="modal">
    <h2 style="margin-top:0; color:var(--success);">Unggah Portofolio</h2>
    <form onsubmit="handleUpload(event)">
      <div class="form-group">
        <label class="form-label">Judul Karya</label>
        <input type="text" id="uJudul" class="form-input" required>
      </div>
      <div class="form-group">
        <label class="form-label">Deskripsi</label>
        <textarea id="uDeskripsi" class="form-input" rows="3" required></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">File (Gambar/Dokumen)</label>
        <input type="file" id="uFile" class="form-input" accept="image/*,.pdf,.doc,.docx" required>
      </div>
      <button type="submit" class="btn" style="width:100%; justify-content:center; background:var(--success);">Kirim Sekarang</button>
    </form>
    <button class="btn-icon" style="position:absolute; top:15px; right:15px;" onclick="closeModal('uploadModal')">‚úï</button>
  </div>
</div>

<div id="toast" class="toast">Notifikasi</div>

<script>
  /* --- CONFIGURATION --- */
  const SHEET_ID = '1iOxHNN6Y5idBTF5QH0zzr3FTxK_YcToOx56KN9I2wlY';
  const GID_USERS = '23797909';
  
  // PENTING: MASUKKAN URL WEB APP GOOGLE APPS SCRIPT DISINI
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyrIKrW19dYIkNSkDTZUBDuyJTbIFuG_1xuVcdXcAJ1AurcryN_0NqCLTZj4bBGX6faqw/exec';

  const CONFIG = {
    gallery: {
      gid: '921098100', query: 'SELECT E,F,J,L WHERE H>3',
      els: { tabs: 'tabs-gallery', row: 'row-gallery', loading: 'loading-gallery' },
      map: (row) => ({
        judul: row[0]?.v || 'Tanpa Judul', gambar: row[1]?.v || '', meta: row[2]?.v || 'Anonim', filter: row[3]?.v || 'Umum', type: 'Siswa'
      })
    },
    briev: {
      gid: '991020926', query: 'SELECT B,D,F,H WHERE B<>""',
      els: { tabs: 'tabs-briev', row: 'row-briev', loading: 'loading-briev' },
      map: (row) => {
        let imgRaw = row[2]?.v || ''; let imgUrl = imgRaw;
        if (imgRaw && !imgRaw.startsWith('http')) imgUrl = `https://drive.google.com/thumbnail?id=${imgRaw}&sz=w400`;
        return { judul: row[0]?.v || '', gambar: imgUrl, meta: row[1]?.v || '', filter: row[3]?.v || '' };
      }
    },
    bootcamp: {
      gid: '1880887156', query: 'SELECT B,C,G,E WHERE B<>""',
      els: { container: 'container-bootcamp', loading: 'loading-bootcamp' },
      map: (row) => {
        let imgRaw = row[2]?.v || ''; let imgUrl = imgRaw;
        if (imgRaw && !imgRaw.startsWith('http')) imgUrl = `https://drive.google.com/thumbnail?id=${imgRaw}&sz=w800`;
        return { judul: row[0]?.v, waktu: row[1]?.v, gambar: imgUrl, ket: row[3]?.v };
      }
    },
    tutorial: {
      gid: '1819053111', query: 'SELECT B,C,G WHERE B<>""',
      els: { container: 'container-tutorial', loading: 'loading-tutorial' },
      map: (row) => {
        let imgRaw = row[2]?.v || ''; let imgUrl = imgRaw;
        if (imgRaw && !imgRaw.startsWith('http')) imgUrl = `https://drive.google.com/thumbnail?id=${imgRaw}&sz=w600`;
        return { judul: row[0]?.v, deskripsi: row[1]?.v, gambar: imgUrl };
      }
    }
  };

  let dataStore = { gallery: [], briev: [], bootcamp: [], tutorial: [] };
  let currentUser = null;

  /* --- THEME & UI LOGIC --- */
  function initTheme() {
    // Load Dark Mode
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') document.body.setAttribute('data-theme', 'dark');
    updateThemeUI();

    // Load Color
    const savedColor = localStorage.getItem('color');
    if (savedColor) {
      document.body.setAttribute('data-color', savedColor);
      document.querySelectorAll('.color-dot').forEach(dot => dot.classList.remove('active'));
      document.querySelector(`.color-dot[onclick*="${savedColor}"]`)?.classList.add('active');
    }
  }

  function toggleTheme() {
    const isDark = document.body.getAttribute('data-theme') === 'dark';
    if (isDark) {
      document.body.removeAttribute('data-theme');
      localStorage.setItem('theme', 'light');
    } else {
      document.body.setAttribute('data-theme', 'dark');
      localStorage.setItem('theme', 'dark');
    }
    updateThemeUI();
  }

  function updateThemeUI() {
    const isDark = document.body.getAttribute('data-theme') === 'dark';
    document.getElementById('theme-label').textContent = isDark ? 'Mode Gelap' : 'Mode Terang';
    document.getElementById('theme-icon').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
  }

  function setColor(color, el) {
    document.body.setAttribute('data-color', color);
    localStorage.setItem('color', color);
    document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
    el.classList.add('active');
  }

  /* --- NAVIGATION --- */
  function switchView(view) {
    // Hide/Show Containers
    document.getElementById('view-home').classList.add('hidden');
    document.getElementById('view-dashboard').classList.add('hidden');
    document.getElementById(`view-${view}`).classList.remove('hidden');

    // Update Pill State
    document.getElementById('pill-home').classList.remove('active');
    document.getElementById('pill-dashboard').classList.remove('active');
    document.getElementById(`pill-${view}`).classList.add('active');
  }

  function openModal(id) { document.getElementById(id).classList.add('open'); }
  function closeModal(id) { document.getElementById(id).classList.remove('open'); }
  window.onclick = (e) => { if(e.target.classList.contains('modal-overlay')) closeModal(e.target.id); }

  /* --- AUTH & LOGIN --- */
  async function handleLogin(e) {
    e.preventDefault();
    const userIn = document.getElementById('username').value;
    const passIn = document.getElementById('password').value;
    const credential = `${userIn}__${passIn}`;
    
    try {
      const query = `SELECT B,C,H WHERE G = '${credential}'`;
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${GID_USERS}&tq=${encodeURIComponent(query)}`;
      const res = await fetch(url);
      const text = await res.text();
      const jsonStr = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
      const data = JSON.parse(jsonStr);

      if (data.table && data.table.rows && data.table.rows.length > 0) {
        const rowData = data.table.rows[0].c;
        currentUser = {
          nama: rowData[0]?.v || 'Siswa', kelas: rowData[1]?.v || '-',
          gambar: rowData[2]?.v || '', username: userIn
        };
        loginSuccessUI();
        closeModal('loginModal');
        showToast(`Halo, ${currentUser.nama}`);
      } else { showToast("Username/Password salah"); }
    } catch (err) { showToast("Gagal koneksi database"); }
  }

  function loginSuccessUI() {
    document.getElementById('btnLogin').classList.add('hidden');
    document.getElementById('userProfile').classList.remove('hidden');
    document.getElementById('dispName').textContent = currentUser.nama;
    document.getElementById('dispClass').textContent = currentUser.kelas;
    
    let imgUrl = currentUser.gambar;
    if (imgUrl && !imgUrl.startsWith('http')) imgUrl = `https://drive.google.com/thumbnail?id=${imgUrl}&sz=w100`;
    if(!imgUrl) imgUrl = 'https://ui-avatars.com/api/?name=' + currentUser.nama + '&background=random';
    document.getElementById('dispAvatar').src = imgUrl;
  }

  function logout() {
    currentUser = null;
    document.getElementById('userProfile').classList.add('hidden');
    document.getElementById('btnLogin').classList.remove('hidden');
    document.getElementById('username').value = ''; document.getElementById('password').value = '';
    showToast("Logout berhasil");
  }

  /* --- DATA FETCHING --- */
  async function initAllData() {
    await Promise.all([fetchData('gallery'), fetchData('briev'), fetchData('bootcamp'), fetchData('tutorial')]);
  }

  async function fetchData(sectionKey) {
    const config = CONFIG[sectionKey];
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${config.gid}&tq=${encodeURIComponent(config.query)}`;
    try {
      const res = await fetch(url);
      const text = await res.text();
      const jsonStr = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
      const data = JSON.parse(jsonStr);
      let results = [];
      if (data.table && data.table.rows) results = data.table.rows.map(r => config.map(r.c));
      dataStore[sectionKey] = results;
      
      if(sectionKey === 'gallery' || sectionKey === 'briev') {
        renderTabs(sectionKey);
        renderRow(sectionKey);
      } else if (sectionKey === 'bootcamp') { renderBootcamp(); } 
      else if (sectionKey === 'tutorial') { renderTutorial(); }
      
      document.getElementById(config.els.loading).classList.add('hidden');
    } catch (e) { console.error(e); document.getElementById(config.els.loading).innerText = "Gagal"; }
  }

  function renderTabs(sectionKey) {
    const config = CONFIG[sectionKey];
    const container = document.getElementById(config.els.tabs);
    const data = dataStore[sectionKey];
    const uniqueFilters = [...new Set(data.map(item => item.filter))];
    container.innerHTML = `<button class="chip active" onclick="filterData('${sectionKey}', 'all')">Semua</button>`;
    uniqueFilters.forEach(filter => {
      const btn = document.createElement('button');
      btn.className = 'chip'; btn.innerText = filter;
      btn.onclick = () => filterData(sectionKey, filter);
      container.appendChild(btn);
    });
  }

  function filterData(sectionKey, filterValue) {
    const config = CONFIG[sectionKey];
    const btns = document.getElementById(config.els.tabs).querySelectorAll('.chip');
    btns.forEach(b => b.classList.toggle('active', b.innerText === filterValue));
    const filtered = (filterValue === 'all') ? dataStore[sectionKey] : dataStore[sectionKey].filter(i => i.filter === filterValue);
    renderRow(sectionKey, filtered);
  }

  function renderRow(sectionKey, data = dataStore[sectionKey]) {
    const container = document.getElementById(CONFIG[sectionKey].els.row);
    if (data.length === 0) { container.innerHTML = '<div style="padding:20px; color:var(--text-muted); font-size:14px;">Tidak ada data.</div>'; return; }
    
    container.innerHTML = data.map(item => `
      <div class="card">
        <img src="${item.gambar}" onerror="this.src='https://via.placeholder.com/260x160?text=No+Image'">
        <div class="card-body">
          <div class="card-tag">${item.filter}</div>
          <h3 class="card-title">${item.judul}</h3>
          <div class="card-meta">${sectionKey==='gallery' ? 'üë§ '+item.meta : 'üìÖ '+item.meta}</div>
          <button class="card-btn" onclick="showToast('${item.judul}')">Lihat</button>
        </div>
      </div>
    `).join('');
    container.scrollLeft = 0;
  }

  function renderBootcamp() {
    const data = dataStore.bootcamp;
    const container = document.getElementById('container-bootcamp');
    container.innerHTML = data.map(item => `
      <div class="news-card">
        <img class="news-img" src="${item.gambar}" onerror="this.src='https://via.placeholder.com/200'">
        <div class="news-content">
          <div class="news-date">${item.waktu}</div>
          <div class="news-headline">${item.judul}</div>
          <div class="news-excerpt">${item.ket}</div>
        </div>
      </div>
    `).join('');
  }

  function renderTutorial() {
    const data = dataStore.tutorial;
    const container = document.getElementById('container-tutorial');
    container.innerHTML = data.map(item => `
      <div class="yt-card" onclick="showToast('Putar: ${item.judul}')">
        <div class="yt-thumb-box"><img class="yt-thumb" src="${item.gambar}" onerror="this.src='https://via.placeholder.com/320x180'"></div>
        <div class="yt-title">${item.judul}</div>
        <div class="yt-desc">${item.deskripsi}</div>
      </div>
    `).join('');
  }

  /* --- UPLOAD LOGIC --- */
  function handleUpload(e) {
    e.preventDefault();
    if (SCRIPT_URL.includes('MASUKKAN')) return showToast("Setup Script URL dulu!");
    
    const file = document.getElementById('uFile').files[0];
    if (!file) return showToast("Pilih file!");

    const reader = new FileReader();
    reader.onload = function(ev) {
      const payload = {
        akun: currentUser ? currentUser.username : 'Guest',
        judul: document.getElementById('uJudul').value,
        deskripsi: document.getElementById('uDeskripsi').value,
        fileData: ev.target.result.substring(ev.target.result.indexOf(',') + 1),
        fileName: file.name, mimeType: file.type
      };
      
      fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) })
      .then(() => { showToast("Berhasil diunggah!"); closeModal('uploadModal'); e.target.reset(); setTimeout(()=>fetchData('gallery'),2000); })
      .catch(() => showToast("Gagal upload."));
    };
    reader.readAsDataURL(file);
  }

  function showToast(msg) {
    const t = document.getElementById('toast'); t.innerText = msg; t.style.display = 'block';
    setTimeout(() => t.style.display = 'none', 3000);
  }

  // Initialize
  initTheme();
  document.addEventListener('DOMContentLoaded', initAllData);
</script>
</body>
</html>
