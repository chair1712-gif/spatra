<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Galeri & Briev Siswa (Login Terintegrasi)</title>
<style>
  /* --- RESET & DASAR --- */
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f4f6f8;
    margin: 0;
    padding: 20px;
    color: #333;
  }

  /* --- HEADER GLOBAL --- */
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 1200px;
    margin: 0 auto 30px auto;
    padding-bottom: 20px;
    border-bottom: 2px solid #e0e0e0;
  }

  h1 { margin: 0; font-size: 24px; color: #333; }

  /* Area Auth (Kanan Header) */
  #auth-section {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .btn-primary {
    background-color: #4f46e5;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s;
  }
  .btn-primary:hover { background-color: #4338ca; }
  .btn-logout {
    background-color: #ef4444;
    padding: 6px 15px;
    font-size: 13px;
  }
  .btn-logout:hover { background-color: #dc2626; }

  /* Style Profil User */
  .user-profile {
    display: flex;
    align-items: center;
    gap: 12px;
    animation: fadeIn 0.5s;
  }
  
  .user-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #4f46e5;
    background-color: #eee;
  }

  .user-info {
    text-align: right;
    line-height: 1.2;
  }

  .user-name {
    font-weight: 700;
    font-size: 15px;
    color: #111;
  }

  .user-class {
    font-size: 12px;
    color: #666;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
  }

  /* --- CONTAINER UTAMA --- */
  .main-container {
    max-width: 1200px;
    margin: 0 auto;
  }

  h2.section-title {
    font-size: 20px;
    color: #555;
    margin: 40px 0 15px 0;
    padding-left: 10px;
    border-left: 5px solid #4f46e5;
  }

  /* --- TABS (FILTER) --- */
  .tabs-container {
    margin-bottom: 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  .tab-btn {
    padding: 6px 16px;
    border: 1px solid #ddd;
    background: white;
    color: #555;
    border-radius: 20px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s;
  }
  .tab-btn:hover { background: #f0f0f0; border-color: #ccc; }
  .tab-btn.active {
    background-color: #4f46e5;
    color: white;
    border-color: #4f46e5;
  }

  /* --- GALLERY HORIZONTAL SCROLL --- */
  .gallery-wrapper {
    position: relative;
    background: white;
    border-radius: 12px;
    padding: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    border: 1px solid #eee;
  }

  .gallery-row {
    display: flex;
    overflow-x: auto;
    gap: 20px;
    padding: 10px 5px 25px 5px;
    scroll-behavior: smooth;
    width: 100%;
  }

  /* Scrollbar styling */
  .gallery-row::-webkit-scrollbar { height: 6px; }
  .gallery-row::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
  .gallery-row::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

  /* --- KARTU --- */
  .card {
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    transition: transform 0.2s;
    flex: 0 0 auto;
    width: 260px;
    display: flex;
    flex-direction: column;
    border: 1px solid #f0f0f0;
  }

  .card:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }

  .card img {
    width: 100%;
    height: 160px;
    object-fit: cover;
    background-color: #f9f9f9;
  }

  .card .content { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
  
  .card h3 { margin: 0 0 5px 0; font-size: 16px; color: #111; line-height: 1.3; }
  
  .card .meta-info {
    font-size: 12px;
    color: #777;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .card .badge {
    display: inline-block;
    background: #f3f4f6;
    color: #4b5563;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    margin-bottom: 8px;
    font-weight: 600;
    width: fit-content;
  }

  .card button {
    margin-top: auto;
    width: 100%;
    padding: 8px;
    border: none;
    background: #f9fafb;
    color: #4f46e5;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    border: 1px solid #e5e7eb;
  }
  .card button:hover { background: #eef2ff; border-color: #c7d2fe; }

  /* --- LOADING --- */
  #loading, #loading-briev { text-align: center; padding: 20px; color: #666; font-size: 14px; }

  /* --- MODAL --- */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); display: none;
    justify-content: center; align-items: center; z-index: 1000;
  }
  .modal-overlay.open { display: flex; }
  .modal-box {
    background: white; padding: 30px; border-radius: 12px;
    width: 90%; max-width: 400px; position: relative;
    box-shadow: 0 20px 25px rgba(0,0,0,0.2);
  }
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
  .form-group { margin-bottom: 15px; }
  .form-group label { display: block; margin-bottom: 5px; font-size: 14px; font-weight: 600; }
  .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }

  /* --- TOAST --- */
  .toast {
    position: fixed; bottom: 20px; right: 20px;
    background: #333; color: white; padding: 12px 24px;
    border-radius: 8px; display: none; z-index: 2000;
  }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <h1>Galeri & Briev</h1>
  
  <div id="auth-section">
    <!-- Tombol Login (Default Tampil) -->
    <button id="btnLogin" class="btn-primary" onclick="openModal('loginModal')">Login</button>
    
    <!-- Profil User (Hidden by default) -->
    <div id="userProfile" class="user-profile" style="display: none;">
      <div class="user-info">
        <div class="user-name" id="dispName">Nama Siswa</div>
        <div class="user-class" id="dispClass">Kelas X</div>
      </div>
      <!-- Avatar Lingkaran -->
      <img id="dispAvatar" class="user-avatar" src="" alt="Profile">
      <button id="btnUpload" class="btn-primary" onclick="openModal('uploadModal')" style="display: none;">+ Upload</button>
      <button id="btnLogout" class="btn-primary btn-logout" onclick="logout()">Logout</button>
    </div>
  </div>
</header>

<!-- MAIN CONTAINER -->
<div class="main-container">

  <!-- === SECTION 1: GALERI === -->
  <div class="section-gallery">
    <div id="tabs-gallery" class="tabs-container">
      <button class="tab-btn active" onclick="filterData('gallery', 'all')">Semua Galeri</button>
    </div>

    <div class="gallery-wrapper">
      <div id="loading">Memuat Galeri...</div>
      <div class="gallery-row" id="row-gallery" style="display: none;"></div>
    </div>
  </div>

  <!-- === SECTION 2: BRIEV === -->
  <h2 class="section-title">Briev & Briefing</h2>
  <div class="section-briev">
    <div id="tabs-briev" class="tabs-container">
      <button class="tab-btn active" onclick="filterData('briev', 'all')">Semua Briev</button>
    </div>

    <div class="gallery-wrapper">
      <div id="loading-briev">Memuat Briev...</div>
      <div class="gallery-row" id="row-briev" style="display: none;"></div>
    </div>
  </div>

</div>

<!-- MODAL LOGIN -->
<div id="loginModal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-header"><h2>Login Siswa</h2><button class="close-btn" onclick="closeModal('loginModal')">&times;</button></div>
    <form onsubmit="handleLogin(event)">
      <div class="form-group"><label>Username</label><input type="text" id="username" placeholder="User ID" required></div>
      <div class="form-group"><label>Password</label><input type="password" id="password" placeholder="Password" required></div>
      <button type="submit" class="btn-primary" style="width: 100%;" id="btnSubmitLogin">Masuk</button>
    </form>
  </div>
</div>

<!-- MODAL UPLOAD -->
<div id="uploadModal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-header"><h2>Upload ke Galeri</h2><button class="close-btn" onclick="closeModal('uploadModal')">&times;</button></div>
    <form onsubmit="handleUpload(event)">
      <div class="form-group"><label>Judul (Kolom E)</label><input type="text" id="uJudul" required></div>
      <div class="form-group"><label>Siswa (Kolom J)</label><input type="text" id="uSiswa" required></div>
      <div class="form-group"><label>Kategori (Kolom L)</label><input type="text" id="uKategori" required></div>
      <div class="form-group"><label>URL Gambar (Kolom F)</label><input type="url" id="uGambar" required></div>
      <button type="submit" class="btn-primary" style="width: 100%;">Simpan</button>
    </form>
  </div>
</div>

<div id="toast" class="toast">Notifikasi</div>

<script>
  // --- KONFIGURASI SHEET ---
  const SHEET_ID = '1iOxHNN6Y5idBTF5QH0zzr3FTxK_YcToOx56KN9I2wlY';
  
  // Sheet User untuk Login
  const GID_USERS = '23797909';
  
  const CONFIG = {
    gallery: {
      gid: '921098100',
      query: 'SELECT E,F,J,L WHERE H>3',
      els: { tabs: 'tabs-gallery', row: 'row-gallery', loading: 'loading' },
      map: (row) => ({
        judul: row[0]?.v || 'Tanpa Judul',
        gambar: row[1]?.v || '',
        meta: row[2]?.v || 'Anonim',
        filter: row[3]?.v || 'Umum',
        type: 'Siswa'
      })
    },
    briev: {
      gid: '991020926',
      query: 'SELECT B,D,F,H WHERE B<>""',
      els: { tabs: 'tabs-briev', row: 'row-briev', loading: 'loading-briev' },
      map: (row) => {
        let imgRaw = row[2]?.v || '';
        let imgUrl = imgRaw;
        if (imgRaw && !imgRaw.startsWith('http')) {
           imgUrl = `https://drive.google.com/thumbnail?id=${imgRaw}&sz=w400`;
        }
        return {
          judul: row[0]?.v || 'Tanpa Judul',
          gambar: imgUrl,
          meta: row[1]?.v || 'Tgl N/A',
          filter: row[3]?.v || 'Umum',
          type: 'Briev'
        };
      }
    }
  };

  let dataStore = { gallery: [], briev: [] };
  let currentUser = null; // Menyimpan data user yang login

  // --- 1. LOGIN SYSTEM (REAL GVIZ) ---
  async function handleLogin(e) {
    e.preventDefault();
    
    const userIn = document.getElementById('username').value;
    const passIn = document.getElementById('password').value;
    const btn = document.getElementById('btnSubmitLogin');
    
    // Format kredensial sesuai permintaan: USER__PASS
    const credential = `${userIn}__${passIn}`;
    
    // UI Loading
    btn.innerText = "Mengecek...";
    btn.disabled = true;

    try {
      // Query Login: SELECT B(Nama), C(Kelas), H(Gambar) WHERE G = 'Credential'
      const query = `SELECT B,C,H WHERE G = '${credential}'`;
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${GID_USERS}&tq=${encodeURIComponent(query)}`;

      const res = await fetch(url);
      const text = await res.text();
      const jsonStr = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
      const data = JSON.parse(jsonStr);

      if (data.table && data.table.rows && data.table.rows.length > 0) {
        // LOGIN BERHASIL
        const rowData = data.table.rows[0].c;
        
        currentUser = {
          nama: rowData[0]?.v || 'Siswa',
          kelas: rowData[1]?.v || '-',
          gambar: rowData[2]?.v || ''
        };

        loginSuccessUI(currentUser);
        closeModal('loginModal');
        showToast(`Selamat datang, ${currentUser.nama}`);
      } else {
        alert("Username atau Password salah! (Format: User__Pass)");
      }
    } catch (err) {
      console.error(err);
      alert("Gagal terkoneksi ke database.");
    } finally {
      btn.innerText = "Masuk";
      btn.disabled = false;
    }
  }

  function loginSuccessUI(user) {
    // Sembunyikan tombol login
    document.getElementById('btnLogin').style.display = 'none';
    
    // Tampilkan Profil
    const profileDiv = document.getElementById('userProfile');
    profileDiv.style.display = 'flex';
    
    // Set Data Teks
    document.getElementById('dispName').textContent = user.nama;
    document.getElementById('dispClass').textContent = user.kelas;
    
    // Set Gambar Avatar (Cek apakah ID atau URL)
    let imgUrl = user.gambar;
    if (imgUrl && !imgUrl.startsWith('http')) {
      imgUrl = `https://drive.google.com/thumbnail?id=${imgUrl}&sz=w100`;
    }
    // Fallback image jika kosong
    if(!imgUrl) imgUrl = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.nama) + '&background=random';
    
    document.getElementById('dispAvatar').src = imgUrl;

    // Tampilkan tombol Upload jika diperlukan
    document.getElementById('btnUpload').style.display = 'block';
  }

  function logout() {
    currentUser = null;
    // Reset UI ke awal
    document.getElementById('userProfile').style.display = 'none';
    document.getElementById('btnLogin').style.display = 'block';
    
    // Clear form
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    
    showToast("Anda telah logout.");
  }

  // --- 2. FETCH DATA SECTIONS ---
  async function initAllData() {
    await fetchData('gallery');
    await fetchData('briev');
  }

  async function fetchData(sectionKey) {
    const config = CONFIG[sectionKey];
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${config.gid}&tq=${encodeURIComponent(config.query)}`;
    
    try {
      const res = await fetch(url);
      const text = await res.text();
      const jsonStr = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
      const data = JSON.parse(jsonStr);

      let results = [];
      if (data.table && data.table.rows) {
        results = data.table.rows.map(r => config.map(r.c));
      }

      dataStore[sectionKey] = results;
      renderTabs(sectionKey);
      renderRow(sectionKey); 
      
      document.getElementById(config.els.loading).style.display = 'none';
      document.getElementById(config.els.row).style.display = 'flex';

    } catch (e) {
      console.error(`Error loading ${sectionKey}:`, e);
      document.getElementById(config.els.loading).innerText = "Gagal memuat data.";
    }
  }

  // --- 3. TABS & RENDERING ---
  function renderTabs(sectionKey) {
    const config = CONFIG[sectionKey];
    const container = document.getElementById(config.els.tabs);
    const data = dataStore[sectionKey];
    const uniqueFilters = [...new Set(data.map(item => item.filter))];
    
    container.innerHTML = `<button class="tab-btn active" onclick="filterData('${sectionKey}', 'all')">Semua</button>`;
    uniqueFilters.forEach(filter => {
      const btn = document.createElement('button');
      btn.className = 'tab-btn';
      btn.innerText = filter;
      btn.onclick = () => filterData(sectionKey, filter);
      container.appendChild(btn);
    });
  }

  function filterData(sectionKey, filterValue) {
    const config = CONFIG[sectionKey];
    const btns = document.getElementById(config.els.tabs).querySelectorAll('.tab-btn');
    btns.forEach(b => b.classList.toggle('active', b.innerText === filterValue));

    const filtered = (filterValue === 'all') 
      ? dataStore[sectionKey] 
      : dataStore[sectionKey].filter(i => i.filter === filterValue);
    
    renderRow(sectionKey, filtered);
  }

  function renderRow(sectionKey, data = dataStore[sectionKey]) {
    const config = CONFIG[sectionKey];
    const container = document.getElementById(config.els.row);
    
    if (data.length === 0) {
      container.innerHTML = '<div style="padding:20px; color:#888;">Data kosong.</div>';
      return;
    }

    container.innerHTML = data.map(item => {
      let metaLabel = (sectionKey === 'gallery') ? `Oleh: ${item.meta}` : `Exp: ${item.meta}`;
      let btnLabel = (sectionKey === 'gallery') ? 'Detail' : 'Lihat';

      return `
        <div class="card">
          <img src="${item.gambar}" alt="${item.judul}" onerror="this.src='https://via.placeholder.com/260x160?text=No+Image'">
          <div class="content">
            <div class="badge">${item.filter}</div>
            <h3>${item.judul}</h3>
            <div class="meta-info"><span>${metaLabel}</span></div>
            <button onclick="showToast('${item.judul}')">${btnLabel}</button>
          </div>
        </div>
      `;
    }).join('');
    
    container.scrollLeft = 0;
  }

  // --- 4. MODAL & UPLOAD ---
  function openModal(id) { document.getElementById(id).classList.add('open'); }
  function closeModal(id) { document.getElementById(id).classList.remove('open'); }
  window.onclick = (e) => { if(e.target.classList.contains('modal-overlay')) closeModal(e.target.id); }

  function handleUpload(e) {
    e.preventDefault();
    // Simulasi upload ke Gallery
    const newItem = {
      judul: document.getElementById('uJudul').value,
      gambar: document.getElementById('uGambar').value,
      meta: document.getElementById('uSiswa').value,
      filter: document.getElementById('uKategori').value,
      type: 'Siswa'
    };
    dataStore['gallery'].unshift(newItem);
    renderTabs('gallery');
    filterData('gallery', 'all');
    
    e.target.reset();
    closeModal('uploadModal');
    showToast("Karya ditambahkan ke Galeri.");
  }

  function showToast(msg) {
    const t = document.getElementById('toast');
    t.innerText = msg; t.style.display = 'block';
    setTimeout(() => t.style.display = 'none', 3000);
  }

  document.addEventListener('DOMContentLoaded', initAllData);
</script>

</body>
</html>
