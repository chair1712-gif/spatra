 <!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SPATRA MEDIA - Portal Siswa</title>
<style>
  /* --- 1. CSS VARIABLES --- */
  :root {
    --bg-body: #f3f4f6;
    --bg-card: #ffffff;
    --bg-header: rgba(255, 255, 255, 0.95);
    --text-main: #1f2937;
    --text-muted: #6b7280;
    --border-color: #e5e7eb;
    --primary: #4f46e5; --primary-hover: #4338ca; --primary-light: #e0e7ff;
    --danger: #ef4444;
    --success: #10b981;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --radius: 12px;
    --transition: all 0.3s ease;
  }

  /* Dark Mode Override */
  [data-theme="dark"] {
    --bg-body: #0f172a;
    --bg-card: #1e293b;
    --bg-header: rgba(15, 23, 42, 0.95);
    --text-main: #f1f5f9;
    --text-muted: #94a3b8;
    --border-color: #334155;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
  }

  /* Color Themes */
  [data-color="purple"] { --primary: #7c3aed; --primary-hover: #6d28d9; --primary-light: #ede9fe; }
  [data-color="rose"] { --primary: #e11d48; --primary-hover: #be123c; --primary-light: #ffe4e6; }
  [data-color="teal"] { --primary: #0d9488; --primary-hover: #0f766e; --primary-light: #ccfbf1; }

  /* --- 2. RESET & BASE --- */
  * { box-sizing: border-box; outline: none; }
  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background-color: var(--bg-body);
    color: var(--text-main);
    margin: 0; padding: 0; transition: background-color 0.3s, color 0.3s;
    padding-bottom: 80px;
  }

  /* --- 3. HEADER & NAV --- */
  header {
    position: sticky; top: 0; z-index: 100;
    background: var(--bg-header);
    backdrop-filter: blur(10px);
    border-bottom:1px solid var(--border-color);
    padding: 10px 20px;
    display: flex; justify-content: space-between; align-items: center;
    height: 70px;
  }
  .brand-container { display: flex; align-items: center; gap: 12px; flex: 1; min-width: 0; }
  .brand-logo { width: 40px; height: 40px; object-fit: cover; border-radius: 8px; border: 1px solid var(--border-color); flex-shrink: 0; }
  .brand-text { display: flex; flex-direction: column; justify-content: center; min-width: 0; }
  .brand-text h1 { margin: 0; font-size: 18px; font-weight: 800; color: var(--primary); letter-spacing: 0.5px; line-height: 1.1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .brand-text p { margin: 2px 0 0 0; font-size: 11px; font-weight: 500; color: var(--text-muted); line-height: 1.2; display: none; }

  .nav-pills { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 30px; padding: 4px; display: flex; gap: 5px; flex-shrink: 0; }
  .nav-pill { border: none; background: transparent; color: var(--text-muted); padding: 6px 14px; border-radius: 25px; font-weight: 600; cursor: pointer; transition: var(--transition); font-size: 13px; }
  .nav-pill.active { background: var(--primary); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

  .controls { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
  .btn-icon { background: transparent; border: 1px solid var(--border-color); color: var(--text-main); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition); }
  .btn-icon:hover { background: var(--primary-light); color: var(--primary); border-color: var(--primary); }

  .user-profile { display: flex; align-items: center; gap: 8px; }
  .user-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); flex-shrink: 0; }
  .user-info { display: flex; flex-direction: column; line-height: 1.2; min-width: 0; }
  .user-name { font-weight: 700; font-size: 13px; }
  .user-class { font-size: 11px; color: var(--text-muted); }

  .btn { background: var(--primary); color: white; border: none; padding: 6px 14px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: var(--transition); display: inline-flex; align-items: center; gap: 6px; font-size: 13px; white-space: nowrap; }
  .btn:hover { background: var(--primary-hover); transform: translateY(-1px); }
  .btn-logout { background: transparent; color: var(--danger); border: 1px solid var(--danger); }
  .btn-logout:hover { background: var(--danger); color: white; }

  /* --- 4. RESPONSIVE MEDIA QUERIES --- */
  @media (min-width: 768px) {
    .brand-text p { display: block; }
    .brand-logo { width: 50px; height: 50px; }
    .brand-text h1 { font-size: 22px; }
    .controls { gap: 15px; }
    .btn-icon { width: 36px; height: 36px; }
    .user-avatar { width: 35px; height: 35px; }
    header { height: 80px; }
  }
  @media (max-width: 600px) {
    .controls { gap: 5px; }
    .user-info { display: none !important; }
    .btn { padding: 6px 8px; font-size: 12px; }
    .btn-text-mobile { display: none; }
    .btn-icon { width: 30px; height: 30px; font-size: 14px; }
    .nav-pills { padding: 3px; }
    .nav-pill { padding: 5px 10px; font-size: 12px; }
  }

  /* --- 5. COMPONENTS --- */
  .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
  .section-title { margin: 25px 0 15px 0; font-size: 18px; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
  .section-title::before { content: ''; width: 4px; height: 18px; background: var(--primary); border-radius: 2px; }

  .chip-container { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
  .chip-container::-webkit-scrollbar { display: none; }
  .chip { padding: 6px 16px; border-radius: 20px; background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-muted); font-size: 13px; font-weight: 600; white-space: nowrap; cursor: pointer; transition: var(--transition); }
  .chip.active { background: var(--primary); color: white; border-color: var(--primary); }

  .scroll-wrapper { background: var(--bg-card); border-radius: var(--radius); padding: 15px; box-shadow: var(--shadow); border:1px solid var(--border-color); }
  .scroll-row { display: flex; gap: 15px; overflow-x: auto; scroll-behavior: smooth; padding-bottom: 10px; }
  .scroll-row::-webkit-scrollbar { height: 4px; }
  .scroll-row::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }

  .card { background: var(--bg-body); border-radius: 10px; overflow: hidden; min-width: 220px; max-width: 240px; flex-shrink: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: var(--transition); border: 1px solid transparent; cursor: pointer; }
  .card:hover { transform: translateY(-4px); box-shadow: var(--shadow); border-color: var(--primary-light); }
  .card img { width: 100%; height: 140px; object-fit: cover; background: #e5e7eb; }
  .card-body { padding: 12px; }
  .card-tag { font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--primary); font-weight: 700; margin-bottom: 5px; }
  .card-title { font-size: 15px; font-weight: 700; margin: 0 0 8px 0; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .card-meta { font-size: 12px; color: var(--text-muted); margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }

  .news-card { display: flex; background: var(--bg-card); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); margin-bottom: 15px; border: 1px solid var(--border-color); transition: var(--transition); cursor: pointer; }
  .news-card:hover { transform: scale(1.01); }
  .news-img { width: 130px; object-fit: cover; min-width: 130px; background: var(--bg-body); }
  .news-content { padding: 15px; flex: 1; display: flex; flex-direction: column; justify-content: center; }
  .news-date { font-size: 11px; color: var(--primary); font-weight: 600; margin-bottom: 5px; }
  .news-headline { font-size: 16px; font-weight: 700; margin: 0 0 5px 0; color: var(--text-main); }
  .news-excerpt { font-size: 13px; color: var(--text-muted); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  @media (min-width: 768px) { .news-img { width: 250px; min-width: 250px; } .news-excerpt { -webkit-line-clamp: 3; } }

  .yt-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100%, 1fr)); gap: 20px; }
  @media (min-width: 600px) { .yt-grid { grid-template-columns: repeat(2, 1fr); } }
  @media (min-width: 900px) { .yt-grid { grid-template-columns: repeat(3, 1fr); } }
  .yt-card { background: transparent; cursor: pointer; transition: var(--transition); }
  .yt-thumb-box { width: 100%; aspect-ratio: 16/9; border-radius: 12px; overflow: hidden; background: var(--bg-body); position: relative; box-shadow: var(--shadow); margin-bottom: 10px; }
  .yt-thumb { width: 100%; height: 100%; object-fit: cover; }
  .yt-title { font-size: 14px; font-weight: 600; color: var(--text-main); margin-bottom: 5px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;}
  .yt-desc { font-size: 12px; color: var(--text-muted); }

  /* --- 6. MODAL & FORM --- */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
  .modal-overlay.open { display: flex; animation: fadeIn 0.3s; }
  .modal { background: var(--bg-card); width: 100%; max-width: 450px; border-radius: 16px; padding: 25px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); position: relative; border: 1px solid var(--border-color); animation: slideUp 0.3s; }
  
  /* Upload Status (Loading/Success) */
  .upload-status { text-align: center; padding: 20px; display: none; }
  .upload-status.active { display: block; }
  .success-msg { color: var(--success); font-weight: 700; font-size: 18px; margin-top: 10px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
  .success-icon { font-size: 40px; }

  .modal-detail { background: var(--bg-card); width: 100%; max-width: 900px; border-radius: 20px; overflow: hidden; position: relative; display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); animation: zoomIn 0.3s; }
  @media (min-width: 768px) {
    .modal-detail { flex-direction: row; height: 80vh; }
    .detail-image { width: 60%; height: 100%; object-fit: cover; }
    .detail-content { width: 40%; overflow-y: auto; }
  }
  @media (max-width: 767px) {
    .modal-detail { height: 90vh; }
    .detail-image { width: 100%; height: 50%; object-fit: cover; }
  }
  .detail-image { background: #000; }
  .detail-content { padding: 30px; position: relative; }
  .detail-close { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.5); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; transition: 0.2s; }
  .detail-close:hover { background: var(--danger); }
  .detail-badge { display: inline-block; background: var(--primary-light); color: var(--primary); padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; margin-bottom: 10px; text-transform: uppercase; }
  .detail-title { font-size: 24px; font-weight: 800; margin: 0 0 10px 0; color: var(--text-main); line-height: 1.2; }
  .detail-meta { font-size: 13px; color: var(--text-muted); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
  
  /* RATING & DESC */
  .rating-stars-container { margin-bottom: 25px; background: rgba(0,0,0,0.02); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); }
  .rating-label { font-size: 12px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; font-weight: 700; }
  .rating-stars { color: #fbbf24; font-size: 28px; letter-spacing: 2px; line-height: 1; }
  .detail-desc-box { background-color: #fff7d1; border-left: 4px solid #facc15; color: #422006; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; line-height: 1.5; }
  .detail-desc-box.hidden { display: none; }
  .detail-desc { font-size: 15px; line-height: 1.6; color: var(--text-muted); margin-bottom: 20px; }

  .form-group { margin-bottom: 15px; }
  .form-label { display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; }
  .form-input { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-body); color: var(--text-main); }
  .form-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }

  .theme-options { display: flex; gap: 10px; margin-top: 10px; }
  .color-dot { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
  .color-dot.active { border-color: var(--text-main); transform: scale(1.1); }
  #bgColorPicker { height: 40px; padding: 2px; cursor: pointer; }

  .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--text-main); color: var(--bg-body); padding: 12px 24px; border-radius: 30px; font-size: 14px; font-weight: 600; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); z-index: 2000; display: none; }
  .loader { border: 3px solid var(--bg-card); border-top: 3px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }

  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  .hidden { display: none !important; }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="brand-container">
    <img src="https://drive.google.com/thumbnail?id=1jjuiSRnNEex2-87cfM1kUiZDs7zucwKr&sz=w200" alt="Logo Sekolah" class="brand-logo">
    <div class="brand-text">
      <h1>SPATRA MEDIA</h1>
      <p>Ekstrakurikuler Informatika SMA N 1 Wiradesa</p>
    </div>
  </div>

  <nav class="nav-pills">
    <button class="nav-pill active" onclick="switchView('home')" id="pill-home">Beranda</button>
    <button class="nav-pill" onclick="switchView('dashboard')" id="pill-dashboard">Dashboard</button>
  </nav>

  <div class="controls">
    <button class="btn-icon" onclick="openModal('settingsModal')">‚öôÔ∏è</button>
    <div id="auth-section">
      <button class="btn" id="btnLogin" onclick="openModal('loginModal')">Login</button>
      <div id="userProfile" class="user-profile hidden">
        <div class="user-info">
          <span class="user-name" id="dispName">Nama</span>
          <span class="user-class" id="dispClass">Kelas</span>
        </div>
        <img id="dispAvatar" class="user-avatar" src="">
        <button class="btn btn-logout" onclick="logout()">
          üö™ <span class="btn-text-mobile">Keluar</span>
        </button>
        <button class="btn" id="btnUpload" style="background: var(--success);" onclick="openModal('uploadModal')">
          + <span class="btn-text-mobile">Unggah</span>
        </button>
      </div>
    </div>
  </div>
</header>

<!-- MAIN CONTAINER -->
<div class="container">
  <!-- VIEW HOME -->
  <div id="view-home" class="view-section">
    <div class="section-title">Galeri Karya Siswa</div>
    <div class="chip-container" id="tabs-gallery">
      <button class="chip active" onclick="filterData('gallery', 'all')">Semua</button>
    </div>
    <div class="scroll-wrapper">
      <div id="loading-gallery" style="padding:20px;"><div class="loader"></div></div>
      <div class="scroll-row" id="row-gallery"></div>
    </div>

    <div class="section-title">Info & Briefing</div>
    <div class="chip-container" id="tabs-briev">
      <button class="chip active" onclick="filterData('briev', 'all')">Semua</button>
    </div>
    <div class="scroll-wrapper">
      <div id="loading-briev" style="padding:20px;"><div class="loader"></div></div>
      <div class="scroll-row" id="row-briev"></div>
    </div>
  </div>

  <!-- VIEW DASHBOARD -->
  <div id="view-dashboard" class="view-section hidden">
    <div class="section-title">Kegiatan Bootcamp</div>
    <div id="loading-bootcamp" style="padding:20px;"><div class="loader"></div></div>
    <div id="container-bootcamp"></div>

    <div class="section-title">Tutorial Video</div>
    <div id="loading-tutorial" style="padding:20px;"><div class="loader"></div></div>
    <div id="container-tutorial" class="yt-grid"></div>
  </div>
</div>

<!-- === MODALS === -->

<!-- Login Modal -->
<div id="loginModal" class="modal-overlay">
  <div class="modal">
    <h2 style="margin-top:0; color:var(--primary);">Masuk Siswa</h2>
    <form onsubmit="handleLogin(event)">
      <div class="form-group"><label class="form-label">Username</label><input type="text" id="username" class="form-input" required></div>
      <div class="form-group"><label class="form-label">Password</label><input type="password" id="password" class="form-input" required></div>
      <button type="submit" class="btn" style="width:100%; justify-content:center;">Login</button>
    </form>
    <button class="btn-icon" style="position:absolute; top:15px; right:15px;" onclick="closeModal('loginModal')">‚úï</button>
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal-overlay">
  <div class="modal">
    <h2 style="margin-top:0;">Pengaturan</h2>
    <div class="form-group">
      <label class="form-label">Mode</label>
      <button class="btn" style="width:100%; justify-content:space-between;" onclick="toggleTheme()">
        <span id="theme-label">Mode Terang</span> <span id="theme-icon">‚òÄÔ∏è</span>
      </button>
    </div>
    <div class="form-group">
      <label class="form-label">Warna Background</label>
      <input type="color" id="bgColorPicker" class="form-input" value="#f3f4f6" oninput="changeBgColor(this.value)">
    </div>
    <div class="form-group">
      <label class="form-label">Warna Tema</label>
      <div class="theme-options">
        <div class="color-dot active" style="background:#4f46e5;" onclick="setColor('blue', this)"></div>
        <div class="color-dot" style="background:#7c3aed;" onclick="setColor('purple', this)"></div>
        <div class="color-dot" style="background:#e11d48;" onclick="setColor('rose', this)"></div>
        <div class="color-dot" style="background:#0d9488;" onclick="setColor('teal', this)"></div>
      </div>
    </div>
    <button class="btn-icon" style="position:absolute; top:15px; right:15px;" onclick="closeModal('settingsModal')">‚úï</button>
  </div>
</div>

<!-- Upload Modal (Updated with Status) -->
<div id="uploadModal" class="modal-overlay">
  <div class="modal">
    <!-- Status Container (Loader / Success) -->
    <div id="uploadStatus" class="upload-status">
      <!-- Loading State -->
      <div id="uploadLoading">
        <div class="loader"></div>
        <p style="margin-top:10px; color:var(--text-muted);">Mengunggah ke Server...</p>
      </div>
      <!-- Success State -->
      <div id="uploadSuccess" class="success-msg hidden">
        <div class="success-icon">‚úÖ</div>
        <p>Berhasil Disimpan!</p>
      </div>
    </div>

    <!-- Form Content -->
    <div id="uploadFormContent">
      <h2 style="margin-top:0; color:var(--success);">Unggah Portofolio</h2>
      <form onsubmit="handleUpload(event)">
        <div class="form-group"><label class="form-label">Judul Karya</label><input type="text" id="uJudul" class="form-input" required></div>
        <div class="form-group">
          <label class="form-label">Jenis Karya</label>
          <select id="uJenisKarya" class="form-input" required>
            <option value="" disabled selected>Pilih Jenis Karya...</option>
            <option value="Desain">Desain</option>
            <option value="FOTO">FOTO</option>
          </select>
        </div>
        <div class="form-group"><label class="form-label">Deskripsi</label><textarea id="uDeskripsi" class="form-input" rows="3" required></textarea></div>
        <div class="form-group"><label class="form-label">File (Gambar/Dokumen)</label><input type="file" id="uFile" class="form-input" accept="image/*,.pdf,.doc,.docx" required></div>
        <button type="submit" id="btnSubmitUpload" class="btn" style="width:100%; justify-content:center; background:var(--success);">Kirim Sekarang</button>
      </form>
    </div>
    
    <button class="btn-icon" style="position:absolute; top:15px; right:15px;" onclick="closeModal('uploadModal')">‚úï</button>
  </div>
</div>

<!-- === DETAIL MODAL === -->
<div id="detailModal" class="modal-overlay">
  <div class="modal-detail">
    <div class="detail-close" onclick="closeModal('detailModal')">‚úï</div>
    <img id="detail-img" class="detail-image" src="">
    <div class="detail-content">
      <span id="detail-badge" class="detail-badge">KATEGORI</span>
      <h2 id="detail-title" class="detail-title">Judul</h2>
      <div id="detail-meta" class="detail-meta">Meta Info</div>
      
      <!-- RATING -->
      <div id="detail-rating-wrapper" class="rating-stars-container hidden">
        <div class="rating-label">Penilaian Juri / Guru</div>
        <div id="detail-rating-stars" class="rating-stars"></div>
      </div>

      <!-- DESKRIPSI (ARSIRAN KUNING) -->
      <div id="detail-desc-yellow" class="detail-desc-box hidden">
        <div class="rating-label">Deskripsi Karya</div>
        <div id="detail-text-desc"></div>
      </div>

      <!-- TEKS PENILAIAN / URAIAN BRIEF -->
      <div id="detail-desc" class="detail-desc">Deskripsi...</div>
      
      <button id="detail-action" class="btn" style="margin-top:20px; width:100%; justify-content:center;">Buka File</button>
    </div>
  </div>
</div>

<div id="toast" class="toast">Notifikasi</div>

<script>
  /* --- CONFIGURATION --- */
  const SHEET_ID = '1iOxHNN6Y5idBTF5QH0zzr3FTxK_YcToOx56KN9I2wlY';
  const GID_USERS = '23797909';
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzWi5TD_qYF8G502GBPu854QdOgyOXv_e_MAcQ0RzC5vm51CKJaGc3y3Idaq6ohjdwu/exec';

  const CONFIG = {
    gallery: {
      gid: '921098100', query: 'SELECT E,F,J,L,H,I,D WHERE E<>""',
      els: { tabs: 'tabs-gallery', row: 'row-gallery', loading: 'loading-gallery' },
      map: (row) => ({
        judul: row[0]?.v,         // E
        gambar: row[1]?.v,       // F
        meta: row[2]?.v,         // J (Nama)
        filter: row[3]?.v,       // L (Kategori)
        rating: row[4]?.v || 0,   // H (Rating)
        penilaian: row[5]?.v,     // I (Teks Penilaian)
        deskripsi: row[6]?.v      // D (Deskripsi)
      })
    },
    briev: {
      gid: '991020926', query: 'SELECT B,D,F,H,E WHERE B<>""',
      els: { tabs: 'tabs-briev', row: 'row-briev', loading: 'loading-briev' },
      map: (row) => {
        let imgRaw = row[2]?.v; let img = (imgRaw && !imgRaw.startsWith('http')) ? `https://drive.google.com/thumbnail?id=${imgRaw}&sz=w400` : imgRaw;
        return { judul: row[0]?.v, waktu: row[1]?.v, gambar: img, filter: row[3]?.v, uraian: row[4]?.v };
      }
    },
    bootcamp: {
      gid: '1880887156', query: 'SELECT B,C,G,E WHERE B<>""',
      els: { container: 'container-bootcamp', loading: 'loading-bootcamp' },
      map: (row) => {
        let imgRaw = row[2]?.v; let img = (imgRaw && !imgRaw.startsWith('http')) ? `https://drive.google.com/thumbnail?id=${imgRaw}&sz=w800` : imgRaw;
        return { judul: row[0]?.v, waktu: row[1]?.v, gambar: img, ket: row[3]?.v };
      }
    },
    tutorial: {
      gid: '1819053111', query: 'SELECT B,C,G,E WHERE B<>""',
      els: { container: 'container-tutorial', loading: 'loading-tutorial' },
      map: (row) => {
        let imgRaw = row[2]?.v; let img = (imgRaw && !imgRaw.startsWith('http')) ? `https://drive.google.com/thumbnail?id=${imgRaw}&sz=w600` : imgRaw;
        return { judul: row[0]?.v, deskripsi: row[1]?.v, gambar: img, link: row[3]?.v };
      }
    }
  };

  let dataStore = { gallery: [], briev: [], bootcamp: [], tutorial: [] };
  let currentUser = null;

  /* --- UI FUNCTIONS --- */
  function initTheme() {
    const t = localStorage.getItem('theme'); if (t === 'dark') document.body.setAttribute('data-theme', 'dark'); updateThemeUI();
    const c = localStorage.getItem('color'); if (c) { document.body.setAttribute('data-color', c); document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active')); document.querySelector(`.color-dot[onclick*="${c}"]`)?.classList.add('active'); }
    const bg = localStorage.getItem('customBg'); if(bg) { document.documentElement.style.setProperty('--bg-body', bg); document.getElementById('bgColorPicker').value = bg; }
  }
  function toggleTheme() {
    const isDark = document.body.getAttribute('data-theme') === 'dark';
    if (isDark) { document.body.removeAttribute('data-theme'); localStorage.setItem('theme', 'light'); } 
    else { document.body.setAttribute('data-theme', 'dark'); localStorage.setItem('theme', 'dark'); }
    updateThemeUI();
  }
  function updateThemeUI() {
    const isDark = document.body.getAttribute('data-theme') === 'dark';
    document.getElementById('theme-label').textContent = isDark ? 'Mode Gelap' : 'Mode Terang';
    document.getElementById('theme-icon').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
  }
  function setColor(color, el) {
    document.body.setAttribute('data-color', color); localStorage.setItem('color', color);
    document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active')); el.classList.add('active');
  }
  function changeBgColor(color) { document.documentElement.style.setProperty('--bg-body', color); localStorage.setItem('customBg', color); }

  function switchView(view) {
    document.getElementById('view-home').classList.add('hidden');
    document.getElementById('view-dashboard').classList.add('hidden');
    document.getElementById(`view-${view}`).classList.remove('hidden');
    document.getElementById('pill-home').classList.remove('active');
    document.getElementById('pill-dashboard').classList.remove('active');
    document.getElementById(`pill-${view}`).classList.add('active');
  }
  function openModal(id) { document.getElementById(id).classList.add('open'); }
  function closeModal(id) { document.getElementById(id).classList.remove('open'); }
  window.onclick = (e) => { if(e.target.classList.contains('modal-overlay')) closeModal(e.target.id); }

  /* --- AUTH --- */
  async function handleLogin(e) {
    e.preventDefault();
    const cred = `${document.getElementById('username').value}__${document.getElementById('password').value}`;
    try {
      const q = `SELECT B,C,H WHERE G = '${cred}'`;
      const u = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${GID_USERS}&tq=${encodeURIComponent(q)}`;
      const r = await fetch(u);
      const txt = await r.text();
      const j = JSON.parse(txt.substring(txt.indexOf('{'), txt.lastIndexOf('}') + 1));
      if (j.table && j.table.rows) {
        const d = j.table.rows[0].c;
        currentUser = { nama: d[0]?.v, kelas: d[1]?.v, gambar: d[2]?.v, username: document.getElementById('username').value };
        document.getElementById('btnLogin').classList.add('hidden');
        document.getElementById('userProfile').classList.remove('hidden');
        document.getElementById('dispName').textContent = currentUser.nama;
        document.getElementById('dispClass').textContent = currentUser.kelas;
        let img = currentUser.gambar;
        if(img && !img.startsWith('http')) img = `https://drive.google.com/thumbnail?id=${img}&sz=w100`;
        else if(!img) img = `https://ui-avatars.com/api/?name=${currentUser.nama}&background=random`;
        document.getElementById('dispAvatar').src = img;
        closeModal('loginModal');
        showToast(`Halo, ${currentUser.nama}`);
      } else showToast("Login Gagal");
    } catch(e) { showToast("Error"); }
  }
  function logout() {
    currentUser = null; document.getElementById('userProfile').classList.add('hidden');
    document.getElementById('btnLogin').classList.remove('hidden');
    document.getElementById('username').value=''; document.getElementById('password').value='';
    showToast("Logout");
  }

  /* --- DETAIL VIEW --- */
  function showDetail(item) {
    document.getElementById('detail-title').textContent = item.judul;
    document.getElementById('detail-badge').textContent = item.filter || 'INFO';
    document.getElementById('detail-meta').textContent = item.waktu || item.meta || '-';
    let imgSrc = item.gambar;
    if(imgSrc && !imgSrc.startsWith('http')) imgSrc = `https://drive.google.com/uc?export=view&id=${imgSrc}`;
    document.getElementById('detail-img').src = imgSrc;

    const ratingWrapper = document.getElementById('detail-rating-wrapper');
    const descYellow = document.getElementById('detail-desc-yellow');
    const descEl = document.getElementById('detail-desc');

    // Handle Rating
    if (item.rating !== undefined && item.penilaian !== undefined) {
      ratingWrapper.classList.remove('hidden');
      descEl.textContent = item.penilaian || "Belum ada penilaian.";
      const r = parseFloat(item.rating) || 0;
      let stars = '';
      for (let i =1; i <=5; i++) {
        if (i <= r) stars += '‚òÖ'; else if (i - 0.5 <= r) stars += '‚ú¶'; else stars += '‚òÜ';
      }
      document.getElementById('detail-rating-stars').textContent = stars;
      if (item.deskripsi) {
        descYellow.classList.remove('hidden');
        document.getElementById('detail-text-desc').textContent = item.deskripsi;
      } else {
        descYellow.classList.add('hidden');
      }
    } else if (item.uraian) {
      ratingWrapper.classList.add('hidden');
      descEl.textContent = item.uraian;
      descYellow.classList.add('hidden');
    } else {
      ratingWrapper.classList.add('hidden');
      descEl.textContent = item.ket || item.deskripsi || "Karya ini diunggah oleh siswa sebagai bagian dari portofolio kreatif mereka.";
      descYellow.classList.add('hidden');
    }

    const btn = document.getElementById('detail-action');
    if (item.link && item.link.startsWith('http')) {
      btn.textContent = "Tonton Video"; btn.onclick = () => window.open(item.link, '_blank');
    } else {
      btn.textContent = "Buka File Asli"; btn.onclick = () => window.open(item.gambar, '_blank');
    }
    
    openModal('detailModal');
  }

  /* --- DATA FETCHING --- */
  async function initAllData() {
    await Promise.all([fetchData('gallery'), fetchData('briev'), fetchData('bootcamp'), fetchData('tutorial')]);
  }
  async function fetchData(key) {
    const c = CONFIG[key];
    const u = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${c.gid}&tq=${encodeURIComponent(c.query)}`;
    try {
      const r = await fetch(u);
      const txt = await r.text();
      const j = JSON.parse(txt.substring(txt.indexOf('{'), txt.lastIndexOf('}') + 1));
      dataStore[key] = (j.table && j.table.rows) ? j.table.rows.map(r => c.map(r.c)) : [];
      if(key === 'gallery' || key === 'briev') { renderTabs(key); renderRow(key); } 
      else if(key === 'bootcamp') renderBootcamp(); else if(key === 'tutorial') renderTutorial();
      document.getElementById(c.els.loading).classList.add('hidden');
    } catch(e) { console.error(e); document.getElementById(c.els.loading).textContent="Gagal"; }
  }

  function renderTabs(key) {
    const c = CONFIG[key];
    const u = [...new Set(dataStore[key].map(i => i.filter))];
    document.getElementById(c.els.tabs).innerHTML = `<button class="chip active" onclick="filterData('${key}', 'all')">Semua</button>` + u.map(f => `<button class="chip" onclick="filterData('${key}', '${f}')">${f}</button>`).join('');
  }
  function filterData(key, val) {
    const c = CONFIG[key];
    document.querySelectorAll(`#${c.els.tabs} .chip`).forEach(b => b.classList.toggle('active', b.textContent===val));
    const d = val==='all' ? dataStore[key] : dataStore[key].filter(i => i.filter===val);
    renderRow(key, d);
  }
  function renderRow(key, d = dataStore[key]) {
    const c = CONFIG[key];
    const el = document.getElementById(c.els.row);
    el.innerHTML = d.map(i => `
      <div class="card" onclick='showDetail(${JSON.stringify(i)})'>
        <img src="${i.gambar}" onerror="this.src='https://via.placeholder.com/260x160?text=No+Image'">
        <div class="card-body">
          <div class="card-tag">${i.filter||'-'}</div>
          <h3 class="card-title">${i.judul}</h3>
          <div class="card-meta">${key==='gallery'?'üë§':'üìÖ'} ${i.meta||i.waktu||'-'}</div>
        </div>
      </div>
    `).join(''); el.scrollLeft = 0;
  }
  function renderBootcamp() {
    const d = dataStore.bootcamp;
    document.getElementById('container-bootcamp').innerHTML = d.map(i => `
      <div class="news-card" onclick='showDetail(${JSON.stringify(i)})'>
        <img class="news-img" src="${i.gambar}" onerror="this.src='https://via.placeholder.com/200'">
        <div class="news-content">
          <div class="news-date">${i.waktu}</div>
          <div class="news-headline">${i.judul}</div>
          <div class="news-excerpt">${i.ket}</div>
        </div>
      </div>
    `).join('');
  }
  function renderTutorial() {
    const d = dataStore.tutorial;
    document.getElementById('container-tutorial').innerHTML = d.map(i => `
      <div class="yt-card" onclick='showDetail(${JSON.stringify(i)})'>
        <div class="yt-thumb-box"><img class="yt-thumb" src="${i.gambar}" onerror="this.src='https://via.placeholder.com/320x180'"></div>
        <div class="yt-title">${i.judul}</div>
        <div class="yt-desc">${i.deskripsi}</div>
      </div>
    `).join('');
  }

  /* --- HANDLE UPLOAD (DENGAN LOADING STATUS) --- */
  function handleUpload(e) {
    e.preventDefault();
    if (!currentUser) return showToast("Harap login dulu!");
    
    const f = document.getElementById('uFile').files[0];
    if (!f) return showToast("Pilih file!");

    // UI Setup
    const statusBox = document.getElementById('uploadStatus');
    const loadDiv = document.getElementById('uploadLoading');
    const successDiv = document.getElementById('uploadSuccess');
    const formContent = document.getElementById('uploadFormContent');
    const submitBtn = document.getElementById('btnSubmitUpload');

    // Mulai Proses Upload
    statusBox.classList.add('active');
    loadDiv.classList.remove('hidden');
    successDiv.classList.add('hidden'); // Sembunyikan sukses jika ada sisa
    formContent.style.display = 'none'; // Sembunyikan form agar user fokus ke status
    submitBtn.disabled = true;

    // Reader
    const reader = new FileReader();
    reader.onload = function(ev) {
      const payload = { 
        akun: currentUser.username, 
        judul: document.getElementById('uJudul').value, 
        deskripsi: document.getElementById('uDeskripsi').value, 
        jenisKarya: document.getElementById('uJenisKarya').value, 
        fileData: ev.target.result.substring(ev.target.result.indexOf(',')+1), 
        fileName: f.name, mimeType: f.type 
      };

      fetch(SCRIPT_URL, { 
        method: 'POST', 
        mode: 'no-cors', 
        headers: {'Content-Type':'application/json'}, 
        body: JSON.stringify(payload) 
      })
      .then(() => {
        // SUKSES
        loadDiv.classList.add('hidden');
        successDiv.classList.remove('hidden');
        
        submitBtn.innerText = "Selesai";
        submitBtn.style.background = "var(--success)";
        submitBtn.onclick = function() { closeModal('uploadModal'); };

        // Tunggu 2 detik agar user melihat sukses, lalu tutup modal dan refresh
        setTimeout(() => {
          closeModal('uploadModal');
          showToast("Karya berhasil ditambahkan!");
          e.target.reset();
          
          // Reset UI Button untuk next upload
          submitBtn.innerText = "Kirim Sekarang";
          submitBtn.disabled = false;
          submitBtn.onclick = null; // Kembalikan handler default
          
          // Reset UI Status Box
          statusBox.classList.remove('active');
          formContent.style.display = 'block';
          
          fetchData('gallery'); // Refresh galeri
        }, 2000);
      })
      .catch(err => {
        // GAGAL
        loadDiv.classList.add('hidden');
        formContent.style.display = 'block';
        submitBtn.disabled = false;
        showToast("Gagal mengunggah file.");
        console.error(err);
      });
    };
    reader.readAsDataURL(f);
  }

  function showToast(m) {
    const t = document.getElementById('toast'); t.textContent = m; t.style.display = 'block';
    setTimeout(() => t.style.display = 'none', 3000);
  }

  initTheme();
  document.addEventListener('DOMContentLoaded', initAllData);
</script>
</body>
</html>
