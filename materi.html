   <!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LKPD Digital - PAI & Budi Pekerti</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* ===== VARIABEL & RESET ===== */
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #06d6a0;
            --secondary-dark: #05c593;
            --accent: #7209b7;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --success: #06d6a0;
            --warning: #ffd166;
            --danger: #ef476f;
            --border-radius: 12px;
            --shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 15px 40px rgba(0, 0, 0, 0.12);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            line-height: 1.3;
        }

        /* ===== LAYOUT KONTAINER ===== */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            min-height: 90vh;
        }

        /* ===== HEADER ===== */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .logo-area h1 {
            font-size: 1.8rem;
            margin-bottom: 0.3rem;
        }

        .logo-area p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.15);
            padding: 10px 20px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
        }

        .user-info span {
            font-weight: 600;
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 6px 15px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: var(--transition);
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.35);
        }

        /* ===== LAYOUT UTAMA ===== */
        .main-layout {
            display: flex;
            min-height: calc(90vh - 90px);
        }

        /* ===== SIDEBAR (TAB NAVIGASI) ===== */
        .sidebar {
            width: 280px;
            background: var(--light);
            border-right: 1px solid var(--light-gray);
            padding: 1.5rem 0;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .sidebar-title {
            padding: 0 1.5rem 1rem;
            font-size: 1.1rem;
            color: var(--primary);
            border-bottom: 1px solid var(--light-gray);
            margin-bottom: 1rem;
        }

        .tab-list {
            list-style: none;
        }

        .tab-item {
            padding: 1rem 1.5rem;
            border-left: 4px solid transparent;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .tab-item:hover {
            background: rgba(67, 97, 238, 0.05);
            border-left-color: rgba(67, 97, 238, 0.3);
        }

        .tab-item.active {
            background: rgba(67, 97, 238, 0.1);
            border-left-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        .tab-icon {
            width: 24px;
            text-align: center;
            color: var(--gray);
        }

        .tab-item.active .tab-icon {
            color: var(--primary);
        }

        /* ===== KONTEN UTAMA ===== */
        .content-area {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--light-gray);
            flex-wrap: wrap;
            gap: 15px;
        }

        .content-header h2 {
            color: var(--primary);
            font-size: 1.8rem;
        }

        .content-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn-jawab {
            background: linear-gradient(to right, var(--secondary), var(--secondary-dark));
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(6, 214, 160, 0.3);
        }

        .btn-jawab:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(6, 214, 160, 0.4);
        }

        .btn-jawab:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-penilaian {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-penilaian:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        /* ===== SUBTAB NAVIGASI ===== */
        .subtab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .subtab-btn {
            padding: 10px 20px;
            background: var(--light);
            border: 1px solid var(--light-gray);
            border-radius: 50px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }

        .subtab-btn:hover {
            background: rgba(67, 97, 238, 0.05);
            border-color: var(--primary);
        }

        .subtab-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* ===== KARTU MATERI ===== */
        .materi-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            border-left: 5px solid var(--primary);
            transition: var(--transition);
        }

        .materi-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .materi-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--gray);
            font-size: 0.9rem;
        }

        .meta-item i {
            color: var(--primary);
        }

        .tujuan-box {
            background: rgba(6, 214, 160, 0.1);
            border-left: 4px solid var(--secondary);
            padding: 1.2rem;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            margin: 1.5rem 0;
        }

        .tujuan-box h4 {
            color: var(--secondary-dark);
            margin-bottom: 0.8rem;
        }

        .tujuan-list {
            list-style: none;
        }

        .tujuan-list li {
            margin-bottom: 0.5rem;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .tujuan-list li:before {
            content: "âœ“";
            color: var(--secondary);
            font-weight: bold;
            flex-shrink: 0;
        }

        /* ===== KONTEN SUBTAB ===== */
        .subtab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .subtab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== TABEL ===== */
        .responsive-table {
            width: 100%;
            overflow-x: auto;
            margin: 1.5rem 0;
            border-radius: var(--border-radius);
            box-shadow: 0 0 0 1px var(--light-gray);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        th {
            background: var(--primary);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--light-gray);
        }

        tr:hover {
            background: rgba(67, 97, 238, 0.03);
        }

        /* ===== MODAL LOGIN ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .login-modal {
            background: white;
            width: 100%;
            max-width: 450px;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.5s ease;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .login-header h2 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .login-body {
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark);
        }

        .input-with-icon {
            position: relative;
        }

        .input-with-icon i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        .input-with-icon input {
            width: 100%;
            padding: 14px 14px 14px 45px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
        }

        .input-with-icon input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .btn-login {
            width: 100%;
            padding: 15px;
            background: linear-gradient(to right, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 10px;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.3);
        }

        .login-footer {
            text-align: center;
            margin-top: 1.5rem;
            color: var(--gray);
            font-size: 0.9rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== MODAL JAWABAN ===== */
        .jawaban-modal {
            background: white;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: var(--border-radius);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .jawaban-header {
            padding: 1.5rem 2rem;
            background: var(--light);
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .jawaban-body {
            padding: 2rem;
        }

        .status-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .status-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .status-label {
            font-size: 0.85rem;
            color: var(--gray);
            font-weight: 600;
        }

        .status-value {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .status-biru {
            color: var(--primary);
        }

        .status-hijau {
            color: var(--secondary);
        }

        .soal-container {
            background: var(--light);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-left: 4px solid var(--accent);
        }

        .soal-container h4 {
            color: var(--accent);
            margin-bottom: 1rem;
        }

        .jawaban-textarea {
            width: 100%;
            min-height: 180px;
            padding: 1.2rem;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-family: 'Open Sans', sans-serif;
            font-size: 1rem;
            resize: vertical;
            transition: var(--transition);
            margin-bottom: 1.5rem;
        }

        .jawaban-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .btn-secondary {
            padding: 12px 28px;
            background: var(--light);
            color: var(--dark);
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-primary {
            padding: 12px 28px;
            background: linear-gradient(to right, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.3);
        }

        .btn-primary:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ===== MODAL PENILAIAN ===== */
        .penilaian-modal {
            background: white;
            width: 100%;
            max-width: 1400px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: var(--border-radius);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }

        .penilaian-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--light-gray);
        }

        .penilaian-header h3 {
            color: var(--primary);
            font-size: 2rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .penilaian-header p {
            color: var(--gray);
            font-size: 1.1rem;
        }

        .penilaian-table-container {
            overflow-x: auto;
            border-radius: 15px;
            border: 1px solid var(--light-gray);
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            max-height: 400px;
            overflow-y: auto;
        }

        .penilaian-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        .penilaian-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }

        .penilaian-table td {
            padding: 15px;
            border-bottom: 1px solid var(--light-gray);
            vertical-align: top;
        }

        .penilaian-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .penilaian-table tr:hover {
            background-color: #f0f7ff;
        }

        .score-cell {
            text-align: center;
            font-weight: bold;
            width: 100px;
        }

        .score-4 { color: #27ae60; background-color: #d5f4e6; }
        .score-3 { color: #f39c12; background-color: #fff3cd; }
        .score-2 { color: #e74c3c; background-color: #fde8e8; }
        .score-1 { color: #95a5a6; background-color: #f8f9fa; }

        .average-cell {
            background-color: #e8f4fc;
            font-weight: bold;
            text-align: center;
        }

        .truncate-text {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: help;
            position: relative;
        }

        .truncate-text:hover::after {
            content: attr(data-fulltext);
            position: absolute;
            left: 0;
            top: 100%;
            background: #333;
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
            white-space: normal;
            width: 400px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* ===== RESUME ANALISIS SATU BARIS (DESKTOP) ===== */
        .resume-baris-satu {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }

        .resume-utama {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .resume-card {
            flex: 1;
            min-width: 200px;
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-top: 5px solid;
            text-align: center;
            transition: var(--transition);
        }

        .resume-card:hover {
            transform: translateY(-5px);
        }

        .resume-substansi { border-color: #3498db; }
        .resume-kedalaman { border-color: #9b59b6; }
        .resume-logika { border-color: #2ecc71; }
        .resume-struktur { border-color: #e74c3c; }
        .resume-overall { border-color: #667eea; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }

        .resume-card-title {
            font-size: 1rem;
            color: #666;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .resume-overall .resume-card-title {
            color: white;
        }

        .resume-card-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .resume-overall .resume-card-value {
            color: white;
            font-size: 3rem;
        }

        .resume-card-predikat {
            font-size: 1rem;
            font-weight: bold;
            padding: 6px 12px;
            border-radius: 50px;
            display: inline-block;
            margin-top: 8px;
        }

        .resume-predikat-sangat-mampu { background-color: #27ae60; color: white; }
        .resume-predikat-tumbuh { background-color: #f39c12; color: white; }
        .resume-predikat-bimbingan { background-color: #e74c3c; color: white; }
        .resume-predikat-belum-mampu { background-color: #95a5a6; color: white; }

        .resume-overall .resume-card-predikat {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .resume-stats {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .resume-stat-item {
            flex: 1;
            min-width: 150px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }

        .resume-stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
        }

        .resume-stat-label {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }

        .penilaian-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        .penilaian-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .penilaian-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(102, 126, 234, 0.3);
        }

        .penilaian-loading {
            text-align: center;
            padding: 60px;
            font-size: 1.2rem;
            color: #666;
        }

        .penilaian-loading i {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 20px;
        }

        .penilaian-error {
            text-align: center;
            padding: 40px;
            background: #fee;
            color: #c00;
            border-radius: 10px;
            border-left: 5px solid #c00;
            margin: 20px 0;
        }

        /* ===== NOTIFIKASI ===== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 1100;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 400px;
            animation: slideIn 0.5s ease, fadeOut 0.5s ease 4.5s forwards;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; }
        }

        .notification-success {
            background: linear-gradient(to right, var(--success), #05c593);
            color: white;
            border-left: 4px solid #04a97f;
        }

        .notification-error {
            background: linear-gradient(to right, var(--danger), #dc3545);
            color: white;
            border-left: 4px solid #c82333;
        }

        .notification-warning {
            background: linear-gradient(to right, var(--warning), #ffc107);
            color: var(--dark);
            border-left: 4px solid #e0a800;
        }

        /* ===== RESPONSIVENESS ===== */
        @media (max-width: 1200px) {
            .resume-utama {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }

        @media (max-width: 992px) {
            .main-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--light-gray);
                max-height: 300px;
            }
            
            .tab-list {
                display: flex;
                overflow-x: auto;
                padding-bottom: 10px;
            }
            
            .tab-item {
                flex-shrink: 0;
                border-left: none;
                border-bottom: 3px solid transparent;
                padding: 0.8rem 1.2rem;
            }
            
            .tab-item.active {
                border-left: none;
                border-bottom-color: var(--primary);
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .user-info {
                align-self: center;
            }
            
            .content-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .content-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .content-actions button {
                width: 100%;
                justify-content: center;
            }
            
            .status-info {
                grid-template-columns: 1fr;
            }
            
            .materi-meta {
                flex-direction: column;
                gap: 10px;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .modal-actions button {
                width: 100%;
            }

            .resume-utama {
                flex-direction: column;
            }
            
            .resume-card {
                min-width: 100%;
            }
            
            .resume-stats {
                flex-direction: column;
            }
            
            .resume-stat-item {
                min-width: 100%;
            }
        }

        @media (max-width: 576px) {
            .container {
                border-radius: 0;
                min-height: 100vh;
            }
            
            body {
                padding: 0;
            }
            
            .jawaban-modal, .login-modal, .penilaian-modal {
                max-height: 100vh;
                border-radius: 0;
                padding: 15px;
            }
            
            .resume-card-value {
                font-size: 2rem;
            }
            
            .resume-overall .resume-card-value {
                font-size: 2.5rem;
            }
        }

        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .mb-4 { margin-bottom: 2rem; }

        .alert {
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
        }

        .alert-success {
            background: rgba(6, 214, 160, 0.1);
            border-left: 4px solid var(--success);
            color: #055c45;
        }

        .alert-error {
            background: rgba(239, 71, 111, 0.1);
            border-left: 4px solid var(--danger);
            color: #b71c37;
        }
    </style>
</head>
<body>
    <!-- MODAL LOGIN (TAMPIL AWAL) -->
    <div id="modalLogin" class="modal-overlay">
        <div class="login-modal">
            <div class="login-header">
                <h2><i class="fas fa-book-open"></i> LKPD Digital</h2>
                <p>Pendidikan Agama Islam & Budi Pekerti</p>
            </div>
            <div class="login-body">
                <div id="loginMessage" class="alert alert-error hidden">Username atau password salah</div>
                
                <div class="form-group">
                    <label for="loginUser"><i class="fas fa-user"></i> Username</label>
                    <div class="input-with-icon">
                        <i class="fas fa-user"></i>
                        <input type="text" id="loginUser" placeholder="Masukkan username">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="loginPass"><i class="fas fa-lock"></i> Password</label>
                    <div class="input-with-icon">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="loginPass" placeholder="Masukkan password">
                    </div>
                </div>
                
                <button id="btnLogin" class="btn-login" onclick="prosesLogin()">
                    <span id="loginText">Masuk ke Dashboard</span>
                </button>
                
                <div class="login-footer">
                    <p>Sistem akan memverifikasi kredensial Anda dari database</p>
                </div>
            </div>
        </div>
    </div>

    <!-- KONTAINER UTAMA (DISEMBUNYIKAN SAMPAI LOGIN) -->
    <div id="mainContainer" class="container hidden">
        <!-- HEADER -->
        <header class="header">
            <div class="logo-area">
                <h1><i class="fas fa-book-open"></i> Lembar Kerja Peserta Didik</h1>
                <p>Pendidikan Agama Islam dan Budi Pekerti - Kelas XII</p>
            </div>
            <div class="user-info">
                <span id="userNameDisplay">Loading...</span>
                <button class="btn-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Keluar</button>
            </div>
        </header>

        <!-- LAYOUT UTAMA -->
        <div class="main-layout">
            <!-- SIDEBAR NAVIGASI (TAB) -->
            <nav class="sidebar">
                <div class="sidebar-title">
                    <i class="fas fa-list-ol"></i> DAFTAR MATERI
                </div>
                <ul class="tab-list" id="tabs">
                    <!-- Tab akan di-generate oleh JavaScript -->
                </ul>
            </nav>

            <!-- AREA KONTEN UTAMA -->
            <main class="content-area">
                <div class="content-header">
                    <h2 id="currentTabTitle">Pilih Materi</h2>
                    <div class="content-actions">
                        <button class="btn-penilaian" id="btnPenilaian" onclick="bukaModalPenilaian()" disabled>
                            <i class="fas fa-chart-bar"></i> Lihat Penilaian
                        </button>
                        <button class="btn-jawab" id="btnJawab" onclick="bukaModalJawaban()" disabled>
                            <i class="fas fa-pen-alt"></i> Jawab Aktivitas
                        </button>
                    </div>
                </div>

                <!-- SUBTAB NAVIGASI -->
                <div class="subtab-nav" id="subtabNav" style="display: none;">
                    <!-- Subtab akan di-generate oleh JavaScript -->
                </div>

                <!-- KONTEN TAB -->
                <div id="tabContents">
                    <!-- Konten akan di-generate oleh JavaScript -->
                </div>
            </main>
        </div>
    </div>

    <!-- MODAL JAWABAN -->
    <div id="modalJawaban" class="modal-overlay hidden">
        <div class="jawaban-modal">
            <div class="jawaban-header">
                <h3><i class="fas fa-pen-alt"></i> Jawab Aktivitas</h3>
                <button class="btn-secondary" onclick="tutupModalJawaban()"><i class="fas fa-times"></i></button>
            </div>
            <div class="jawaban-body">
                <div class="status-info">
                    <div class="status-item">
                        <div class="status-label">NAMA SISWA</div>
                        <div class="status-value" id="namaUserModal">-</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">BAB AKTIF</div>
                        <div class="status-value status-biru" id="babAktifModal">-</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">AKTIVITAS AKTIF</div>
                        <div class="status-value status-hijau" id="aktivitasAktifModal">-</div>
                    </div>
                </div>

                <div class="soal-container">
                    <h4><i class="fas fa-question-circle"></i> SOAL / PERINTAH</h4>
                    <div id="soalText">Pilih aktivitas terlebih dahulu untuk melihat soal.</div>
                </div>

                <textarea class="jawaban-textarea" id="jawabanText" placeholder="Ketik jawaban Anda di sini..."></textarea>

                <div class="modal-actions">
                    <button class="btn-secondary" onclick="tutupModalJawaban()">Batal</button>
                    <button class="btn-primary" id="btnSimpanJawaban" onclick="simpanJawaban()">
                        <i class="fas fa-save"></i> Simpan Jawaban
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PENILAIAN -->
    <div id="modalPenilaian" class="modal-overlay hidden">
        <div class="penilaian-modal">
            <div class="penilaian-header">
                <h3><i class="fas fa-chart-bar"></i> Analisis Penilaian Siswa</h3>
                <p>Data penilaian untuk: <strong id="userPenilaianDisplay">Loading...</strong></p>
            </div>

            <div id="penilaianTableContainer">
                <div class="penilaian-loading" id="penilaianLoading">
                    <i class="fas fa-spinner fa-spin"></i><br>
                    <p>Memuat data penilaian dari Google Sheets...</p>
                </div>
            </div>

            <div id="penilaianResumeContainer" style="display: none;">
                <div class="resume-baris-satu">
                    <div class="resume-utama" id="resumeUtama">
                        <!-- Kartu resume dalam satu baris -->
                    </div>
                    
                    <div class="resume-stats" id="resumeStats">
                        <!-- Statistik akan dimuat di sini -->
                    </div>
                </div>
                
                <div class="penilaian-actions">
                    <button class="penilaian-btn" id="penilaianRefreshBtn">
                        <i class="fas fa-sync-alt"></i> Refresh Data
                    </button>
                    <button class="btn-secondary" onclick="tutupModalPenilaian()">
                        <i class="fas fa-times"></i> Tutup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* ===============================
           VARIABEL GLOBAL & KONFIGURASI
        ================================ */
        let currentUser = null;
        let dataSheet = [];
        let currentTab = 0;
        let currentSubTab = 0;
        let jawabanSiswa = {};
        let userCredentials = [];

        // URL Google Forms untuk pengiriman jawaban
        const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdZt-yddm01A7SutSfoUrWBgHDWcG_W7O3ZBOUVDAMgHPH7Ww/formResponse";
        const FORM_FIELD_USER = "entry.938287234";
        const FORM_FIELD_JAWABAN = "entry.1856668952";

        // URL Google Sheets untuk login (gid=695370535)
        const LOGIN_SHEET_ID = "1_c6-TdEb2MogFIKksz-Zw_kbL3vDTCsGp7UL6V4qfr0";
        const LOGIN_GID = "695370535";
        const LOGIN_QUERY = "SELECT I"; // Kolom I berisi data User#Password

        // URL Google Sheets untuk materi (gid=2053759199)
        const MATERI_SHEET_ID = "1_c6-TdEb2MogFIKksz-Zw_kbL3vDTCsGp7UL6V4qfr0";
        const MATERI_GID = "2053759199";
        const MATERI_QUERY = "SELECT A,B,C,D,E,F,G,H,I where J LIKE 'XII%'";

        // URL Google Sheets untuk penilaian (gid=757145188)
        const PENILAIAN_SHEET_ID = "1_c6-TdEb2MogFIKksz-Zw_kbL3vDTCsGp7UL6V4qfr0";
        const PENILAIAN_GID = "757145188";

        /* ===============================
           FUNGSI UTILITAS
        ================================ */
        function fti(dateObj) {
            if (!(dateObj instanceof Date) || isNaN(dateObj)) return "-";
            const hari = ["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"];
            const bulan = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
            return `${hari[dateObj.getDay()]}, ${dateObj.getDate()} ${bulan[dateObj.getMonth()]} ${dateObj.getFullYear()}`;
        }

        function parseGvizDate(str) {
            if (!str) return null;
            const m = str.match(/Date\((\d+),(\d+),(\d+)\)/);
            return m ? new Date(parseInt(m[1]), parseInt(m[2]), parseInt(m[3])) : null;
        }

        function showNotification(message, type = "success") {
            // Hapus notifikasi sebelumnya
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();
            
            // Buat notifikasi baru
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            // Hapus otomatis setelah 5 detik
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        /* ===============================
           SISTEM LOGIN DARI GOOGLE SHEETS
        ================================ */
        async function loadUserCredentials() {
            const url = `https://docs.google.com/spreadsheets/d/${LOGIN_SHEET_ID}/gviz/tq?gid=${LOGIN_GID}&tq=${encodeURIComponent(LOGIN_QUERY)}`;
            
            try {
                const response = await fetch(url);
                const text = await response.text();
                const json = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1));
                
                userCredentials = [];
                json.table.rows.forEach(row => {
                    if (row.c[0] && row.c[0].v) {
                        const userPass = row.c[0].v.toString();
                        if (userPass.includes('#')) {
                            userCredentials.push(userPass);
                        }
                    }
                });
                
                console.log("Credential loaded:", userCredentials.length);
                return true;
            } catch (error) {
                console.error("Error loading credentials:", error);
                showLoginMessage("Gagal memuat database pengguna", "error");
                return false;
            }
        }

        function prosesLogin() {
            const username = document.getElementById("loginUser").value.trim();
            const password = document.getElementById("loginPass").value.trim();
            
            if (!username || !password) {
                showLoginMessage("Harap isi username dan password", "error");
                return;
            }
            
            // Tampilkan loading
            const btn = document.getElementById("btnLogin");
            const loginText = document.getElementById("loginText");
            btn.disabled = true;
            loginText.innerHTML = '<span class="loading"></span> Memverifikasi...';
            
            // Verifikasi kredensial
            const userPass = `${username}#${password}`;
            const isValid = userCredentials.some(cred => cred === userPass);
            
            setTimeout(() => {
                if (isValid) {
                    currentUser = username;
                    showLoginMessage("Login berhasil! Mengalihkan...", "success");
                    
                    // Simpan session
                    localStorage.setItem('lkpd_user', username);
                    localStorage.setItem('lkpd_logout_time', Date.now() + (8 * 60 * 60 * 1000)); // 8 jam
                    
                    // Tampilkan dashboard
                    setTimeout(() => {
                        document.getElementById("modalLogin").classList.add("hidden");
                        document.getElementById("mainContainer").classList.remove("hidden");
                        document.getElementById("userNameDisplay").textContent = username;
                        document.getElementById("userPenilaianDisplay").textContent = username;
                        
                        // Load data materi
                        loadMateriData();
                    }, 1000);
                } else {
                    showLoginMessage("Username atau password salah", "error");
                    btn.disabled = false;
                    loginText.textContent = "Masuk ke Dashboard";
                }
            }, 800);
        }

        function showLoginMessage(message, type) {
            const msgEl = document.getElementById("loginMessage");
            msgEl.textContent = message;
            msgEl.className = `alert alert-${type}`;
            msgEl.classList.remove("hidden");
            
            if (type === "success") {
                msgEl.style.background = "rgba(6, 214, 160, 0.1)";
                msgEl.style.borderLeftColor = "#06d6a0";
                msgEl.style.color = "#055c45";
            } else {
                msgEl.style.background = "rgba(239, 71, 111, 0.1)";
                msgEl.style.borderLeftColor = "#ef476f";
                msgEl.style.color = "#b71c37";
            }
        }

        function logout() {
            if (confirm("Apakah Anda yakin ingin keluar?")) {
                localStorage.removeItem('lkpd_user');
                localStorage.removeItem('lkpd_logout_time');
                currentUser = null;
                document.getElementById("mainContainer").classList.add("hidden");
                document.getElementById("modalLogin").classList.remove("hidden");
                
                // Reset form
                document.getElementById("loginUser").value = "";
                document.getElementById("loginPass").value = "";
                document.getElementById("loginMessage").classList.add("hidden");
                
                const btn = document.getElementById("btnLogin");
                btn.disabled = false;
                document.getElementById("loginText").textContent = "Masuk ke Dashboard";
            }
        }

        /* ===============================
           LOAD DATA MATERI
        ================================ */
        async function loadMateriData() {
            const url = `https://docs.google.com/spreadsheets/d/${MATERI_SHEET_ID}/gviz/tq?gid=${MATERI_GID}&tq=${encodeURIComponent(MATERI_QUERY)}`;
            
            try {
                const response = await fetch(url);
                const text = await response.text();
                const json = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1));
                
                const headers = json.table.cols.map(c => c.label || "");
                const tabsContainer = document.getElementById("tabs");
                const contentsContainer = document.getElementById("tabContents");
                
                tabsContainer.innerHTML = "";
                contentsContainer.innerHTML = "";
                
                dataSheet = json.table.rows.map(row => row.c.map(c => c ? c.v : ""));
                
                json.table.rows.forEach((row, i) => {
                    const data = row.c.map(c => c ? c.v : "");
                    const judulTab = data[0] || `Materi ${i+1}`;
                    
                    // Buat tab item
                    const tabItem = document.createElement("li");
                    tabItem.className = i === 0 ? "tab-item active" : "tab-item";
                    tabItem.innerHTML = `
                        <span class="tab-icon"><i class="fas fa-book"></i></span>
                        <span>${judulTab}</span>
                    `;
                    tabItem.onclick = () => aktifTab(i);
                    tabsContainer.appendChild(tabItem);
                    
                    // Buat konten tab
                    const tabContent = document.createElement("div");
                    tabContent.className = "tab-content";
                    tabContent.id = `tab-content-${i}`;
                    tabContent.style.display = i === 0 ? "block" : "none";
                    
                    const materi = data[1] || "";
                    const tanggal = parseGvizDate(data[7]);
                    const tujuan = data[8] || "";
                    
                    // Siapkan subtab
                    let subtabButtons = "";
                    let subtabContents = "";
                    const subHeaders = headers.slice(2, 7);
                    
                    for (let col = 2; col <= 6; col++) {
                        const subIndex = col - 2;
                        const headerText = subHeaders[subIndex] || `Aktivitas ${subIndex + 1}`;
                        
                        subtabButtons += `
                            <button class="subtab-btn ${subIndex === 0 ? 'active' : ''}" 
                                    onclick="aktifSubTab(${i}, ${subIndex})">
                                ${headerText}
                            </button>
                        `;
                        
                        let isi = "";
                        const cellData = data[col] || "";
                        
                        if (col === 6) {
                            isi = `<div class="responsive-table">
                                <table>
                                    <thead><tr><th>Kolom 1</th><th>Kolom 2</th><th>Kolom 3</th></tr></thead>
                                    <tbody>`;
                            
                            if (cellData && typeof cellData === 'string') {
                                const baris = cellData.split("()").filter(b => b.trim());
                                baris.forEach(b => {
                                    const kolom = b.split("#");
                                    isi += `<tr>`;
                                    for(let k = 0; k < 3; k++) {
                                        isi += `<td>${kolom[k] || ""}</td>`;
                                    }
                                    isi += `</tr>`;
                                });
                            }
                            isi += `</tbody></table></div>`;
                        } else {
                            isi = `<div class="materi-content">${cellData.toString().replace(/\n/g, "<br>")}</div>`;
                        }
                        
                        subtabContents += `
                            <div class="subtab-content ${subIndex === 0 ? 'active' : ''}" 
                                 id="subtab-${i}-${subIndex}">
                                ${isi}
                            </div>
                        `;
                    }
                    
                    tabContent.innerHTML = `
                        <div class="materi-card">
                            <h3>${judulTab}</h3>
                            <div class="materi-meta">
                                <div class="meta-item">
                                    <i class="fas fa-book"></i>
                                    <span><strong>Materi:</strong> ${materi || "-"}</span>
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-calendar"></i>
                                    <span><strong>Tanggal:</strong> ${fti(tanggal)}</span>
                                </div>
                            </div>
                            
                            <div class="tujuan-box">
                                <h4><i class="fas fa-bullseye"></i> TUJUAN PEMBELAJARAN</h4>
                                ${tujuan ? 
                                    `<ul class="tujuan-list">${tujuan.split(",").map(x => 
                                        `<li>${x.trim()}</li>`).join("")}</ul>` 
                                    : "<p>-</p>"}
                            </div>
                            
                            <div class="mb-3">
                                <h4><i class="fas fa-tasks"></i> AKTIVITAS PEMBELAJARAN</h4>
                                <div class="subtab-nav" id="subtab-nav-${i}">
                                    ${subtabButtons}
                                </div>
                            </div>
                            
                            ${subtabContents}
                        </div>
                    `;
                    
                    contentsContainer.appendChild(tabContent);
                });
                
                // Aktifkan tab pertama
                if (json.table.rows.length > 0) {
                    aktifTab(0);
                    document.getElementById("btnJawab").disabled = false;
                    document.getElementById("btnPenilaian").disabled = false;
                }
                
            } catch (error) {
                console.error("Error loading materi:", error);
                document.getElementById("tabContents").innerHTML = `
                    <div class="alert alert-error">
                        <h4><i class="fas fa-exclamation-triangle"></i> Gagal Memuat Data</h4>
                        <p>Terjadi kesalahan saat memuat materi. Periksa koneksi internet Anda.</p>
                    </div>
                `;
            }
        }

        /* ===============================
           FUNGSI TAB & SUBTAB
        ================================ */
        function aktifTab(i) {
            currentTab = i;
            currentSubTab = 0;
            
            // Update tab aktif
            document.querySelectorAll(".tab-item").forEach((tab, idx) => {
                tab.classList.toggle("active", idx === i);
            });
            
            // Update konten tab
            document.querySelectorAll(".tab-content").forEach((content, idx) => {
                content.style.display = idx === i ? "block" : "none";
            });
            
            // Update title
            const tabTitle = document.querySelectorAll(".tab-item")[i];
            document.getElementById("currentTabTitle").textContent = tabTitle ? tabTitle.textContent.trim() : "Materi";
            
            // Update subtab
            const subtabNav = document.getElementById(`subtab-nav-${i}`);
            document.querySelectorAll(".subtab-nav").forEach(nav => {
                nav.style.display = "none";
            });
            if (subtabNav) {
                subtabNav.style.display = "flex";
                aktifSubTab(i, 0);
            }
            
            updateTombolJawab();
        }

        function aktifSubTab(tabIndex, subIndex) {
            currentTab = tabIndex;
            currentSubTab = subIndex;
            
            const tab = document.getElementById(`tab-content-${tabIndex}`);
            if (!tab) return;
            
            // Update tombol subtab aktif
            tab.querySelectorAll(".subtab-btn").forEach((btn, idx) => {
                btn.classList.toggle("active", idx === subIndex);
            });
            
            // Update konten subtab aktif
            tab.querySelectorAll(".subtab-content").forEach((content, idx) => {
                content.classList.toggle("active", idx === subIndex);
            });
            
            updateTombolJawab();
        }

        function updateTombolJawab() {
            const btn = document.getElementById("btnJawab");
            if (btn) {
                btn.innerHTML = `<i class="fas fa-pen-alt"></i> Jawab Bab ${currentTab + 1} - Aktivitas ${currentSubTab + 1}`;
            }
        }

        /* ===============================
           MODAL JAWABAN
        ================================ */
        function bukaModalJawaban() {
            if (!currentUser) {
                alert("Harap login terlebih dahulu!");
                return;
            }
            
            // Update informasi modal
            document.getElementById("namaUserModal").textContent = currentUser;
            document.getElementById("babAktifModal").textContent = `Bab ${currentTab + 1}`;
            document.getElementById("aktivitasAktifModal").textContent = `Aktivitas ${currentSubTab + 1}`;
            
            // Ambil soal dari dataSheet
            let soal = "";
            if (dataSheet[currentTab] && dataSheet[currentTab][currentSubTab + 2]) {
                soal = dataSheet[currentTab][currentSubTab + 2];
            } else {
                soal = "Tidak ada soal tersedia untuk aktivitas ini.";
            }
            
            // Tampilkan soal
            document.getElementById("soalText").innerHTML = soal.replace(/\n/g, "<br>");
            
            // Cek jawaban sebelumnya
            const key = `bab${currentTab}_akt${currentSubTab}`;
            if (jawabanSiswa[key]) {
                document.getElementById("jawabanText").value = jawabanSiswa[key];
            } else {
                document.getElementById("jawabanText").value = "";
            }
            
            // Reset state tombol simpan
            const btnSimpan = document.getElementById("btnSimpanJawaban");
            btnSimpan.disabled = false;
            btnSimpan.innerHTML = `<i class="fas fa-save"></i> Simpan Jawaban`;
            
            // Tampilkan modal
            document.getElementById("modalJawaban").classList.remove("hidden");
        }

        function tutupModalJawaban() {
            document.getElementById("modalJawaban").classList.add("hidden");
        }

        /* ===============================
           FUNGSI SIMPAN JAWABAN KE GOOGLE FORMS
        ================================ */
        async function simpanJawaban() {
            const jawaban = document.getElementById("jawabanText").value.trim();
            
            if (!jawaban) {
                showNotification("Harap tulis jawaban Anda sebelum menyimpan!", "error");
                return;
            }
            
           /*--------------------------------------------------------*/
           let kj = 'Literasi digital sangat penting bagi generasi muda karena tiga alasan utama. Pertama, dari aspek keamanan, generasi muda rentan terhadap ancaman seperti penipuan online, pencurian data, dan cyberbullying. Literasi digital mengajarkan mereka untuk mengenali dan melindungi diri dari risiko tersebut. Kedua, dari aspek informasi, banjir informasi di internet membuat muda-mudi mudah terpapar oleh hoaks dan misinformasi. ';
  let js = 'Literasi digital itu penting karena sekarang semuanya pakai internet. Anak muda harus bisa pakai gadget biar tidak ketinggalan zaman. Selain itu, dengan bisa internetan, mereka bisa main media sosial dan dapat banyak teman. Jadi, literasi digital wajib dipelajari. Dengan literasi digital, mereka dilatih untuk berpikir kritis dan memverifikasi sumber. Ketiga, dari aspek partisipasi, literasi digital memungkinkan generasi muda untuk menciptakan konten secara bertanggung jawab dan menggunakan platform digital untuk hal yang produktif';

  let sim = similarity(kj, js); // kesamaan umum
  let panjang = js.split(" ").length;

  // IDE & PEMAHAMAN
  let skor_ide = sim > 0.35 ? 4 : sim > 0.25 ? 3 : sim > 0.15 ? 2 : 1;

  // STRUKTUR & KOHERENSI
  let skor_struktur = js.includes("karena") && js.includes("jadi") ? 4 : js.includes("karena") ? 3 : 2;

  // DETAIL
  let alasan = js.split("karena").length - 1;
  let skor_detail = alasan >= 3 ? 4 : alasan == 2 ? 3 : alasan == 1 ? 2 : 1;

  // BAHASA
  let skor_bahasa = panjang >= 80 ? 4 : panjang >= 50 ? 3 : panjang >= 30 ? 2 : 1;

  // NILAI MORAL
  let skor_moral = js.match(/tanggung|baik|bijak|bertanggung|etika/) ? 4 : js.match(/wajib|harus/) ? 3 : 2;

  let rata = (skor_ide + skor_struktur + skor_detail + skor_bahasa + skor_moral) / 5;
  let nilai = (rata * 25).toFixed(1);

  let predikat = nilai >= 90 ? "A - Sangat Baik" :
                 nilai >= 80 ? "B - Baik" :
                 nilai >= 70 ? "C - Cukup" :
                 "D - Perlu Bimbingan";

           
            // Format string jawaban sesuai permintaan: BAB/AKTIVITAS/jawaban
            const jawabanString = `${currentTab + 1}/${currentSubTab + 1}/${jawaban}/${skor_ide}-${skor_struktur}-${skor_detail}-${skor_bahasa}`;
            
            // Simpan ke memori lokal
            const key = `bab${currentTab}_akt${currentSubTab}`;
            jawabanSiswa[key] = jawaban;
            localStorage.setItem(`jawaban_${currentUser}`, JSON.stringify(jawabanSiswa));
            
            // Disable tombol simpan dan tampilkan loading
            const btnSimpan = document.getElementById("btnSimpanJawaban");
            btnSimpan.disabled = true;
            btnSimpan.innerHTML = `<span class="loading"></span> Mengirim...`;
            
            try {
                // Kirim ke Google Forms sesuai format yang diminta
                await kirimKeGoogleForms(jawabanString);
                
                // Tampilkan notifikasi sukses
                showNotification(`Jawaban berhasil dikirim! Bab ${currentTab + 1}, Aktivitas ${currentSubTab + 1}`, "success");
                
                // Tutup modal setelah 2 detik
                setTimeout(() => {
                    tutupModalJawaban();
                }, 2000);
                
            } catch (error) {
                // Tampilkan notifikasi error
                showNotification("Gagal mengirim jawaban ke server. Jawaban disimpan lokal.", "error");
                
                // Reset tombol simpan
                btnSimpan.disabled = false;
                btnSimpan.innerHTML = `<i class="fas fa-save"></i> Simpan Jawaban`;
            }
        }

        async function kirimKeGoogleForms(jawabanString) {
            const params = 
                FORM_FIELD_USER + "=" + encodeURIComponent(currentUser) + "&" +
                FORM_FIELD_JAWABAN + "=" + encodeURIComponent(jawabanString);
            
            const finalURL = FORM_URL + "?" + params;
            
            console.log("Mengirim ke Google Forms:", finalURL);
            
            await fetch(finalURL, { 
                method: "POST", 
                mode: "no-cors",
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            });
            
            return true;
        }

        /* ===============================
           MODAL PENILAIAN - QUERY DINAMIS BERDASARKAN USER
        ================================ */
        function bukaModalPenilaian() {
            if (!currentUser) {
                alert("Harap login terlebih dahulu!");
                return;
            }
            
            // Update nama user di modal
            document.getElementById("userPenilaianDisplay").textContent = currentUser;
            
            // Tampilkan modal
            document.getElementById("modalPenilaian").classList.remove("hidden");
            
            // Load data penilaian
            loadPenilaianData();
        }

        function tutupModalPenilaian() {
            document.getElementById("modalPenilaian").classList.add("hidden");
        }

        async function loadPenilaianData() {
            // Buat query dinamis berdasarkan user yang login
            const penilaianQuery = `select D,E,F,H,I,J,K where B="${currentUser}" order by D asc, E asc`;
            const url = `https://docs.google.com/spreadsheets/d/${PENILAIAN_SHEET_ID}/gviz/tq?gid=${PENILAIAN_GID}&tq=${encodeURIComponent(penilaianQuery)}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                
                const text = await response.text();
                const match = text.match(/google\.visualization\.Query\.setResponse\((.*)\);/s);
                
                if (!match) throw new Error('Format respons tidak valid');
                
                const data = JSON.parse(match[1]);
                
                if (data.status === 'error') {
                    throw new Error(data.errors[0].detailed_message || 'Query error');
                }
                
                displayPenilaianTable(data.table);
                calculatePenilaianSummary(data.table);
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById("penilaianTableContainer").innerHTML = `
                    <div class="penilaian-error">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        <h3>Gagal Memuat Data Penilaian</h3>
                        <p>${error.message}</p>
                        <p style="margin-top: 10px; font-size: 0.9rem;">
                            Query: <code>select D,E,F,H,I,J,K where B="${currentUser}"</code>
                        </p>
                    </div>
                `;
                document.getElementById("penilaianResumeContainer").style.display = 'none';
            }
        }

        function displayPenilaianTable(tableData) {
            const container = document.getElementById("penilaianTableContainer");
            
            if (!tableData.rows || tableData.rows.length === 0) {
                container.innerHTML = `
                    <div class="penilaian-error">
                        <i class="fas fa-database"></i><br>
                        <h3>Tidak Ada Data Penilaian</h3>
                        <p>Belum ada data penilaian untuk user: <strong>${currentUser}</strong></p>
                        <p style="margin-top: 10px; font-size: 0.9rem;">
                            Query: <code>select D,E,F,H,I,J,K where B="${currentUser}"</code>
                        </p>
                    </div>
                `;
                document.getElementById("penilaianResumeContainer").style.display = 'none';
                return;
            }
            
            // Mapping kolom berdasarkan query
            const columnMapping = [
                { name: 'BAB', index: 0, type: 'text' },
                { name: 'AKTIVITAS', index: 1, type: 'text' },
                { name: 'JAWABAN', index: 2, type: 'text' },
                { name: 'SUBSTANSI', index: 3, type: 'number' },
                { name: 'KEDALAMAN', index: 4, type: 'number' },
                { name: 'LOGIS NALAR', index: 5, type: 'number' },
                { name: 'STRUKTUR', index: 6, type: 'number' }
            ];
            
            // Fungsi untuk memotong teks menjadi maksimal 100 huruf
            function truncateText(text, maxLength = 100) {
                if (!text || typeof text !== 'string') return '';
                if (text.length <= maxLength) return text;
                return text.substring(0, maxLength) + '...';
            }
            
            // Fungsi untuk mendapatkan kelas CSS berdasarkan nilai
            function getScoreClass(score) {
                if (score >= 3.5) return "score-4";
                if (score >= 2.5) return "score-3";
                if (score >= 1.5) return "score-2";
                return "score-1";
            }
            
            let html = `
                <div class="penilaian-table-container">
                    <table class="penilaian-table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>BAB</th>
                                <th>AKTIVITAS</th>
                                <th>JAWABAN</th>
                                <th>SUBSTANSI</th>
                                <th>KEDALAMAN</th>
                                <th>LOGIS NALAR</th>
                                <th>STRUKTUR</th>
                                <th>RATA-RATA</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            tableData.rows.forEach((row, index) => {
                const rowData = columnMapping.map(col => {
                    const cell = row.c[col.index];
                    return cell ? cell.v : '';
                });
                
                const nilaiSubstansi = parseFloat(rowData[3]) || 0;
                const nilaiKedalaman = parseFloat(rowData[4]) || 0;
                const nilaiLogika = parseFloat(rowData[5]) || 0;
                const nilaiStruktur = parseFloat(rowData[6]) || 0;
                
                const nilaiArray = [nilaiSubstansi, nilaiKedalaman, nilaiLogika, nilaiStruktur];
                const validScores = nilaiArray.filter(n => n > 0);
                const rataRata = validScores.length > 0 ? 
                    validScores.reduce((a, b) => a + b, 0) / validScores.length : 0;
                
                const jawabanFull = rowData[2] || '';
                const jawabanTruncated = truncateText(jawabanFull);
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${rowData[0] || ''}</td>
                        <td>${rowData[1] || ''}</td>
                        <td class="truncate-text" data-fulltext="${jawabanFull.replace(/"/g, '&quot;')}">
                            ${jawabanTruncated}
                        </td>
                        <td class="score-cell ${getScoreClass(nilaiSubstansi)}">${nilaiSubstansi || '-'}</td>
                        <td class="score-cell ${getScoreClass(nilaiKedalaman)}">${nilaiKedalaman || '-'}</td>
                        <td class="score-cell ${getScoreClass(nilaiLogika)}">${nilaiLogika || '-'}</td>
                        <td class="score-cell ${getScoreClass(nilaiStruktur)}">${nilaiStruktur || '-'}</td>
                        <td class="score-cell average-cell ${getScoreClass(rataRata)}">
                            ${rataRata > 0 ? rataRata.toFixed(2) : '-'}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            document.getElementById("penilaianResumeContainer").style.display = 'block';
        }

        function calculatePenilaianSummary(tableData) {
            if (!tableData.rows || tableData.rows.length === 0) return;
            
            // Mapping kolom
            const columnMapping = [
                { name: 'BAB', index: 0, type: 'text' },
                { name: 'AKTIVITAS', index: 1, type: 'text' },
                { name: 'JAWABAN', index: 2, type: 'text' },
                { name: 'SUBSTANSI', index: 3, type: 'number' },
                { name: 'KEDALAMAN', index: 4, type: 'number' },
                { name: 'LOGIS NALAR', index: 5, type: 'number' },
                { name: 'STRUKTUR', index: 6, type: 'number' }
            ];
            
            // Inisialisasi array untuk menyimpan nilai
            const nilaiSubstansi = [];
            const nilaiKedalaman = [];
            const nilaiLogika = [];
            const nilaiStruktur = [];
            const rataRataPerBaris = [];
            
            // Kumpulkan semua nilai
            tableData.rows.forEach(row => {
                const rowData = columnMapping.map(col => {
                    const cell = row.c[col.index];
                    return cell ? cell.v : '';
                });
                
                const substansi = parseFloat(rowData[3]);
                const kedalaman = parseFloat(rowData[4]);
                const logika = parseFloat(rowData[5]);
                const struktur = parseFloat(rowData[6]);
                
                if (!isNaN(substansi) && substansi > 0) nilaiSubstansi.push(substansi);
                if (!isNaN(kedalaman) && kedalaman > 0) nilaiKedalaman.push(kedalaman);
                if (!isNaN(logika) && logika > 0) nilaiLogika.push(logika);
                if (!isNaN(struktur) && struktur > 0) nilaiStruktur.push(struktur);
                
                const nilaiArray = [substansi, kedalaman, logika, struktur];
                const validScores = nilaiArray.filter(n => !isNaN(n) && n > 0);
                if (validScores.length > 0) {
                    const rataBaris = validScores.reduce((a, b) => a + b, 0) / validScores.length;
                    rataRataPerBaris.push(rataBaris);
                }
            });
            
            // Hitung rata-rata masing-masing nilai
            const avgSubstansi = nilaiSubstansi.length > 0 ? 
                nilaiSubstansi.reduce((a, b) => a + b, 0) / nilaiSubstansi.length : 0;
            const avgKedalaman = nilaiKedalaman.length > 0 ? 
                nilaiKedalaman.reduce((a, b) => a + b, 0) / nilaiKedalaman.length : 0;
            const avgLogika = nilaiLogika.length > 0 ? 
                nilaiLogika.reduce((a, b) => a + b, 0) / nilaiLogika.length : 0;
            const avgStruktur = nilaiStruktur.length > 0 ? 
                nilaiStruktur.reduce((a, b) => a + b, 0) / nilaiStruktur.length : 0;
            
            const allAverages = [avgSubstansi, avgKedalaman, avgLogika, avgStruktur];
            const validAverages = allAverages.filter(avg => avg > 0);
            const avgKeseluruhan = validAverages.length > 0 ?
                validAverages.reduce((a, b) => a + b, 0) / validAverages.length : 0;
            
            // Fungsi untuk mendapatkan predikat
            function getPredikat(score) {
                if (score >= 3.5) return { text: 'Sangat Mampu', class: 'resume-predikat-sangat-mampu' };
                if (score >= 2.5) return { text: 'Sudah Tumbuh', class: 'resume-predikat-tumbuh' };
                if (score >= 1.5) return { text: 'Perlu Bimbingan', class: 'resume-predikat-bimbingan' };
                return { text: 'Belum Mampu', class: 'resume-predikat-belum-mampu' };
            }
            
            // Fungsi untuk mendapatkan kelas CSS berdasarkan nilai
            function getScoreClass(score) {
                if (score >= 3.5) return "score-4";
                if (score >= 2.5) return "score-3";
                if (score >= 1.5) return "score-2";
                return "score-1";
            }
            
            // Tampilkan resume dalam satu baris (desktop)
            const resumeUtama = document.getElementById("resumeUtama");
            const assessments = [
                { name: 'SUBSTANSI', value: avgSubstansi, class: 'resume-substansi' },
                { name: 'KEDALAMAN', value: avgKedalaman, class: 'resume-kedalaman' },
                { name: 'LOGIS NALAR', value: avgLogika, class: 'resume-logika' },
                { name: 'STRUKTUR', value: avgStruktur, class: 'resume-struktur' },
                { name: 'KESELURUHAN', value: avgKeseluruhan, class: 'resume-overall' }
            ];
            
            let html = '';
            assessments.forEach(assessment => {
                const predikat = getPredikat(assessment.value);
                const scoreClass = getScoreClass(assessment.value);
                
                html += `
                    <div class="resume-card ${assessment.class}">
                        <div class="resume-card-title">
                            <i class="fas fa-star"></i>
                            ${assessment.name}
                        </div>
                        <div class="resume-card-value ${scoreClass}">
                            ${assessment.value > 0 ? assessment.value.toFixed(2) : '0.00'}
                        </div>
                        <div class="resume-card-predikat ${predikat.class}">
                            ${predikat.text}
                        </div>
                    </div>
                `;
            });
            
            resumeUtama.innerHTML = html;
            
            // Tampilkan statistik
            const resumeStats = document.getElementById("resumeStats");
            const stats = {
                totalData: tableData.rows.length,
                dataDinilai: rataRataPerBaris.length,
                nilaiRataRata: rataRataPerBaris.length > 0 ? 
                    rataRataPerBaris.reduce((a, b) => a + b, 0) / rataRataPerBaris.length : 0,
                nilaiTertinggi: rataRataPerBaris.length > 0 ? Math.max(...rataRataPerBaris) : 0,
                nilaiTerendah: rataRataPerBaris.length > 0 ? Math.min(...rataRataPerBaris) : 0
            };
            
            const statsHtml = `
                <div class="resume-stat-item">
                    <div class="resume-stat-value">${stats.totalData}</div>
                    <div class="resume-stat-label">Total Data</div>
                </div>
                <div class="resume-stat-item">
                    <div class="resume-stat-value">${stats.dataDinilai}</div>
                    <div class="resume-stat-label">Data Dinilai</div>
                </div>
                <div class="resume-stat-item">
                    <div class="resume-stat-value">${stats.nilaiRataRata.toFixed(2)}</div>
                    <div class="resume-stat-label">Rata-rata Umum</div>
                </div>
                <div class="resume-stat-item">
                    <div class="resume-stat-value">${stats.nilaiTertinggi.toFixed(2)}</div>
                    <div class="resume-stat-label">Nilai Tertinggi</div>
                </div>
                <div class="resume-stat-item">
                    <div class="resume-stat-value">${stats.nilaiTerendah.toFixed(2)}</div>
                    <div class="resume-stat-label">Nilai Terendah</div>
                </div>
            `;
            
            resumeStats.innerHTML = statsHtml;
            
            // Setup tombol refresh
            document.getElementById("penilaianRefreshBtn").onclick = loadPenilaianData;
        }

        /* ===============================
           AUTO LOGOUT SETELAH 8 JAM
        ================================ */
        function checkAutoLogout() {
            const logoutTime = localStorage.getItem('lkpd_logout_time');
            const currentUser = localStorage.getItem('lkpd_user');
            
            if (currentUser && logoutTime) {
                const now = Date.now();
                if (now > parseInt(logoutTime)) {
                    // Auto logout setelah 8 jam
                    localStorage.removeItem('lkpd_user');
                    localStorage.removeItem('lkpd_logout_time');
                    alert('Sesi telah berakhir. Silakan login kembali.');
                    window.location.reload();
                }
            }
        }

        /* ===============================
           INISIALISASI APLIKASI
        ================================ */
        document.addEventListener("DOMContentLoaded", async function() {
            // Cek auto logout
            checkAutoLogout();
            
            // Cek session sebelumnya
            const savedUser = localStorage.getItem('lkpd_user');
            if (savedUser) {
                currentUser = savedUser;
                document.getElementById("modalLogin").classList.add("hidden");
                document.getElementById("mainContainer").classList.remove("hidden");
                document.getElementById("userNameDisplay").textContent = savedUser;
                document.getElementById("userPenilaianDisplay").textContent = savedUser;
                
                // Load jawaban sebelumnya
                const savedJawaban = localStorage.getItem(`jawaban_${savedUser}`);
                if (savedJawaban) {
                    try {
                        jawabanSiswa = JSON.parse(savedJawaban);
                    } catch (e) {
                        jawabanSiswa = {};
                    }
                }
                
                // Load data
                await loadUserCredentials();
                loadMateriData();
            } else {
                // Tampilkan login, load credentials
                await loadUserCredentials();
            }
            
            // Event listener untuk enter di form login
            document.getElementById("loginPass").addEventListener("keypress", function(e) {
                if (e.key === "Enter") prosesLogin();
            });
            
            // Event listener untuk klik di luar modal
            document.addEventListener("click", function(event) {
                if (event.target.classList.contains("modal-overlay")) {
                    if (!event.target.classList.contains("hidden")) {
                        event.target.classList.add("hidden");
                    }
                }
            });
            
            // Event listener untuk escape key
            document.addEventListener("keydown", function(e) {
                if (e.key === "Escape") {
                    tutupModalJawaban();
                    tutupModalPenilaian();
                }
            });
            
            // Setup auto logout check setiap 5 menit
            setInterval(checkAutoLogout, 5 * 60 * 1000);
        });
        
        function similarity(a, b) {
  let A = a.toLowerCase().split(/\W+/);
  let B = b.toLowerCase().split(/\W+/);
  let common = A.filter(word => B.includes(word));
  return (common.length / Math.max(A.length, B.length));
}

 
    </script>
</body>
</html>
