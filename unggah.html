 <!DOCTYPE html>
<html>
<head>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <title>üì§ Upload File ke Folder x</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 500px; margin: 20px auto; padding: 20px; }
    .card { background: #f8f9fa; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    input, select, button { width: 100%; padding: 12px; margin: 8px 0; box-sizing: border-box; }
    button { background: #1976d2; color: white; border: none; cursor: pointer; border-radius: 5px; }
    button:hover { background: #1565c0; }
    .status { margin-top: 15px; padding: 10px; border-radius: 5px; }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .file-info { background: #fff3cd; padding: 10px; margin: 10px 0; border-radius: 5px; }
  </style>
</head>
<body>

<div class='card'>
  <h2 style='text-align: center; color: #1976d2;'>üì§ Upload File ke Folder</h2>
  
  <form id='uploadForm'>
    <input type='text' id='nama' name='nama' placeholder='Nama Lengkap' required>
    
    <select id='kelas' name='kelas'>
      <option value=''>-- Pilih Kelas --</option>
      <option value='10A'>Kelas 10A</option>
      <option value='10B'>Kelas 10B</option>
      <option value='11A'>Kelas 11A</option>
      <option value='11B'>Kelas 11B</option>
      <option value='12A'>Kelas 12A</option>
      <option value='12B'>Kelas 12B</option>
    </select>
    
    <input type='text' id='keterangan' name='keterangan' placeholder='Keterangan (opsional)'>
    
    <input type='file' id='fileInput' accept='image/*,.pdf,.doc,.docx,.xls,.xlsx' required>
    
    <div class='file-info' id='filePreview' style='display: none;'>
      <strong>File yang dipilih:</strong>
      <span id='fileName'></span>
      <br>
      <small>Size: <span id='fileSize'></span></small>
      <button type='button' onclick='clearFile()' style='width: auto; padding: 5px 10px; background: #dc3545; margin-top: 5px;'>Hapus</button>
    </div>
    
    <button type='submit'>üìÅ Upload ke Folder</button>
  </form>
  
  <div id='status' class='status'></div>
  
  <div id='result' style='display: none; margin-top: 20px; padding: 15px; background: #e7f3fe; border-radius: 5px;'>
    <h3>‚úÖ Upload Berhasil!</h3>
    <p><strong>File:</strong> <span id='resultFileName'></span></p>
    <p><strong>Folder:</strong> <span id='resultFolder'></span></p>
    <p><strong>Link File:</strong> <a href='#' id='resultLink' target='_blank'>Buka File</a></p>
    <p><strong>Link Folder:</strong> <a href='#' id='resultFolderLink' target='_blank'>Buka Folder</a></p>
  </div>
</div>

<script>
// GANTI URL INI DENGAN URL DEPLOYMENT ANDA
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwp1CBj9ncba_aLYKmMsto7K3dk8fZo7W3m88VyYciP47WWhsiMZDpIIGN01jfZXq3U/exec';

let selectedFile = null;

// Event listener untuk form
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const statusDiv = document.getElementById('status');
  const resultDiv = document.getElementById('result');
  
  // Reset tampilan
  statusDiv.className = 'status info';
  statusDiv.innerHTML = '‚è≥ Memproses...';
  resultDiv.style.display = 'none';
  
  // Validasi
  const nama = document.getElementById('nama').value.trim();
  if (!nama) {
    statusDiv.className = 'status error';
    statusDiv.innerHTML = '‚ùå Nama harus diisi';
    return;
  }
  
  if (!selectedFile) {
    statusDiv.className = 'status error';
    statusDiv.innerHTML = '‚ùå Pilih file terlebih dahulu';
    return;
  }
  
  // Konversi file ke Base64
  statusDiv.innerHTML = '‚è≥ Mengkonversi file...';
  
  try {
    const base64Data = await fileToBase64(selectedFile);
    
    // Siapkan data untuk dikirim
    const uploadData = {
      nama: nama,
      kelas: document.getElementById('kelas').value,
      keterangan: document.getElementById('keterangan').value,
      file: base64Data,
      filename: selectedFile.name,
      type: selectedFile.type,
      size: selectedFile.size,
      timestamp: new Date().toISOString()
    };
    
    // Kirim ke Google Apps Script
    statusDiv.innerHTML = '‚è≥ Mengupload ke Google Drive...';
    
    const response = await uploadFile(uploadData);
    
    if (response.success) {
      // Tampilkan hasil
      statusDiv.className = 'status success';
      statusDiv.innerHTML = '‚úÖ ' + response.message;
      
      document.getElementById('resultFileName').textContent = response.details.fileName;
      document.getElementById('resultFolder').textContent = response.details.folderName;
      document.getElementById('resultLink').href = response.details.viewUrl;
      document.getElementById('resultFolderLink').href = response.details.folderUrl;
      
      resultDiv.style.display = 'block';
      
      // Reset form
      document.getElementById('uploadForm').reset();
      document.getElementById('filePreview').style.display = 'none';
      selectedFile = null;
      
    } else {
      statusDiv.className = 'status error';
      statusDiv.innerHTML = '‚ùå ' + response.error;
    }
    
  } catch (error) {
    console.error('Upload error:', error);
    statusDiv.className = 'status error';
    statusDiv.innerHTML = '‚ùå Error: ' + error.message;
  }
});

// File input change handler
document.getElementById('fileInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    selectedFile = file;
    
    // Tampilkan preview
    document.getElementById('filePreview').style.display = 'block';
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatFileSize(file.size);
  }
});

// Fungsi untuk upload file
async function uploadFile(data) {
  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    });
    
    return await response.json();
    
  } catch (error) {
    // Fallback: coba dengan XMLHttpRequest jika fetch gagal
    return new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', SCRIPT_URL);
      xhr.setRequestHeader('Content-Type', 'application/json');
      
      xhr.onload = function() {
        try {
          resolve(JSON.parse(xhr.responseText));
        } catch (e) {
          resolve({ success: false, error: 'Invalid server response' });
        }
      };
      
      xhr.onerror = function() {
        reject(new Error('Network error'));
      };
      
      xhr.send(JSON.stringify(data));
    });
  }
}

// Konversi file ke Base64
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = function(e) {
      const base64 = e.target.result.split(',')[1];
      if (base64) {
        resolve(base64);
      } else {
        reject(new Error('Gagal mengkonversi file'));
      }
    };
    reader.onerror = function() {
      reject(new Error('Gagal membaca file'));
    };
    reader.readAsDataURL(file);
  });
}

// Format ukuran file
function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Clear file selection
function clearFile() {
  document.getElementById('fileInput').value = '';
  document.getElementById('filePreview').style.display = 'none';
  selectedFile = null;
}

// Cek koneksi saat load
window.addEventListener('load', function() {
  fetch(SCRIPT_URL)
    .then(response => {
      console.log('Server connected:', response.status);
    })
    .catch(error => {
      console.warn('Server connection check failed:', error);
    });
});
</script>

</body>
</html>
